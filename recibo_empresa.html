<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Recibo Empresa - Fluxo Driver</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root{
    --bg:#ffffff;
    --page-gap:#f3f5f8;
    --card:#fafbfc;
    --card-strong:#f0f2f5;
    --panel:#ffffff;
    --brand:#0b5bd7;
    --brand-dark:#073f8a;
    --text:#0b1115;
    --muted:#65707a;
    --radius:14px;
    --shadow:0 6px 16px rgba(13,30,45,0.07);
}
.dark{
    --bg:#0f1115;
    --page-gap:#15171c;
    --card:#181a20;
    --card-strong:#1d1f27;
    --panel:#1b1d25;
    --text:#e5e7eb;
    --muted:#9ca3af;
    --brand:#3b82f6;
    --brand-dark:#2563eb;
    --shadow:0 6px 16px rgba(0,0,0,0.35);
}

*{ box-sizing:border-box; }
body{
    margin:0;
    font-family:Inter,Roboto,Arial,sans-serif;
    background:linear-gradient(180deg,var(--page-gap),var(--bg) 50%);
    color:var(--text);
    padding-bottom:160px;
    padding-top:60px;
}

/* MENU SUPERIOR */
.top-menu{
    position:fixed;
    top:0; left:0;
    width:100%;
    background:var(--panel);
    display:flex;
    padding:8px;
    gap:8px;
    align-items:center;
    z-index:9999;
    overflow-x:auto;
    box-shadow:var(--shadow);
}
.top-menu button{
    padding:10px 14px;
    background:var(--card);
    border:1px solid rgba(0,0,0,0.08);
    border-radius:10px;
    font-weight:700;
    cursor:pointer;
    flex-shrink:0;
    color:var(--text);
}

/* HEADER */
header{
    padding:18px 16px;
    max-width:980px;
    margin:0 auto;
    display:flex;
    align-items:center;
    justify-content:space-between;
}

#toggleTheme{
    background:var(--card-strong);
    padding:8px 12px;border-radius:10px;
    border:1px solid rgba(0,0,0,.15);
    font-weight:700;color:var(--text);
    cursor:pointer;
}

/* CONTAINER */
.container{max-width:980px;margin:0 auto;padding:0 16px;}

/* TABS */
.tabs{ display:flex; gap:10px; margin-bottom:16px; }
.tab{
    flex:1;text-align:center;padding:12px;background:var(--card);
    border-radius:var(--radius);font-weight:700;
    cursor:pointer;color:var(--muted);
    border:1px solid #d7dce2;transition:.25s;
}
.tab.active{
    background:linear-gradient(135deg,var(--brand),var(--brand-dark));
    color:#fff;border:none;
}

/* CARD */
.card{
    background:var(--card);
    border-radius:var(--radius);
    padding:20px;margin-bottom:18px;
    border:1px solid #d7dce2;box-shadow:var(--shadow);
}
.card h3{margin-top:0;margin-bottom:12px;}

.form input,.form select,.form textarea{
    width:100%;padding:12px;border-radius:10px;
    border:1px solid #cfd4da;background:var(--panel);
    color:var(--text);margin-bottom:12px;font-size:15px;
}
textarea{resize:vertical;min-height:80px}

.funcionario-block{
    background:var(--card-strong);
    padding:14px;border-radius:12px;margin-bottom:10px;
}

/* BOT√ÉO */
button{
    width:auto;padding:14px;border:none;border-radius:10px;
    font-size:15px;font-weight:700;cursor:pointer;
    background:linear-gradient(135deg,var(--brand),var(--brand-dark));
    color:#fff;
}
</style>
</head>

<body>

<script>
// BLOQUEIO SOMENTE PRO
(function(){
  const plano = (localStorage.getItem('planoAtual')||'free').toLowerCase();
  if(plano !== 'pro'){
     alert("Recibo Empresa √© exclusivo do plano PRO.");
     location.href='planos.html';
  }
})();
</script>

<div class="top-menu">
  <button onclick="location.href='planos.html'">üíé Planos</button>
  <button onclick="location.href='perfil.html'">üë§ Perfil</button>
  <button onclick="location.href='index.html'">üè† Dashboard</button>
  <button onclick="location.href='entradas.html'">üíµ Caixa</button>
  <button onclick="location.href='resumo.html'">üßÆ Resumo</button>
  <button onclick="location.href='recibo_empresa.html'">üè≠ Empresa</button>
  <button onclick="location.href='recibo_particular.html'">üöò Particular</button>
  <button onclick="location.href='manutencao.html'">üõ† Manuten√ß√£o</button>
  <button onclick="location.href='calculadora.html'">üìü Calculadora</button>
</div>

<header>
    <div class="brand">
        <div class="logo">RF Driver</div>
        <h1 style="margin:0;font-size:30px;font-weight:800">Recibo Empresas</h1>
    </div>
    <button id="toggleTheme">üåô</button>
</header>

<div class="container">
<!-- TABS -->
<div class="tabs">
    <div class="tab active" data-tab="cadastro">Cadastro</div>
    <div class="tab" data-tab="emitir">Emitir Recibo</div>
    <div class="tab" data-tab="historico">Hist√≥rico</div>
</div>

<!-- =============== TAB - CADASTRO ================= -->
<div id="tab-cadastro" class="card">
  <h3>Dados da empresa / motorista</h3>

  <div class="form">
      <input id="empresa" placeholder="Empresa (opcional)">
      <input id="cnpj" placeholder="CNPJ (opcional)">
      <input id="motorista" placeholder="Nome do Motorista *">
      <input id="cpf" placeholder="CPF ou RG *">
      <input id="marca" placeholder="Marca *">
      <input id="modelo" placeholder="Modelo *">
      <input id="placa" placeholder="Placa *">
      <input id="cor" placeholder="Cor *">

      <button id="savePerfil">Salvar Dados</button>
  </div>
</div>


<!-- =============== TAB - EMITIR ================= -->
<div id="tab-emitir" class="card" style="display:none;">

  <h3>Dados b√°sicos da viagem</h3>

  <div class="form">

    <input id="empresaDestino" placeholder="Empresa de destino">
    <input id="empresaResponsavel" placeholder="Empresa respons√°vel pelos funcion√°rios">
    <input id="solicitante" placeholder="Solicitante">
    <input id="horaChegada" type="time" placeholder="Hor√°rio de chegada">
    <textarea id="descricao" placeholder="Descri√ß√£o da viagem / tipo de servi√ßo"></textarea>

    <h3 style="margin-top:20px;">Funcion√°rios</h3>

    <div id="funcionariosContainer"></div>

    <div style="display:flex; gap:10px;">
      <button type="button" id="addFuncionarioBtn">+ Adicionar</button>
      <button type="button" id="removerFuncionarioBtn" style="background:#777;">- Remover</button>
    </div>

    <h3 style="margin-top:20px;">Hor√°rios e KM</h3>

    <input id="horaInicio" type="time" placeholder="Hor√°rio inicial">
    <input id="kmInicial" type="number" placeholder="KM inicial">
    <input id="horaFim" type="time" placeholder="Hor√°rio final">
    <input id="kmFinal" type="number" placeholder="KM final">

    <div style="margin-top:12px;">
      <strong>Total KM: </strong><span id="totalKmDisplay">0</span><br>
      <strong>Espera: </strong><span id="tempoEsperaDisplay">0 min</span><br>
      <strong>Viagem: </strong><span id="tempoViagemDisplay">0 min</span>
    </div>

    <h3 style="margin-top:20px;">Resumo financeiro</h3>

    <input id="valor" type="number" step="0.01" placeholder="Valor total da viagem (R$)">
    <input id="dataViagem" type="date" placeholder="Data da viagem">

    <button id="emitirPdf">Gerar PDF</button>
    <button id="enviarWa" style="background:#128c7e;">Enviar WhatsApp</button>

  </div>

</div>


<!-- =============== TAB - HIST√ìRICO ================= -->
<div id="tab-historico" class="card" style="display:none;">
  <h3>Hist√≥rico de recibos</h3>
  <div id="listaRecibos"></div>
</div>

<script>
// THEME
function applyTheme(theme){
  const btn = document.getElementById("toggleTheme");
  if(theme === "dark"){
    document.documentElement.classList.add("dark");
    localStorage.setItem("theme","dark");
    if(btn) btn.innerText = "‚òÄÔ∏è";
  } else {
    document.documentElement.classList.remove("dark");
    localStorage.setItem("theme","light");
    if(btn) btn.innerText = "üåô";
  }
}
(function initTheme(){
  const saved = localStorage.getItem("theme") || "light";
  applyTheme(saved);
  const btn = document.getElementById("toggleTheme");
  if(btn){
    btn.addEventListener("click", ()=>applyTheme(
      document.documentElement.classList.contains("dark")?"light":"dark"
    ));
  }
})();
</script>


<script>
// HELPERS
const $ = id => document.getElementById(id);
const RECIBOS_KEY = "recibosViagemEmpresa";

function loadRecibos(){
  try { return JSON.parse(localStorage.getItem(RECIBOS_KEY) || "[]"); }
  catch(e){ return []; }
}
function saveRecibos(list){
  localStorage.setItem(RECIBOS_KEY, JSON.stringify(list));
}

function formatDateBr(iso){
  if(!iso) return "-";
  const d = new Date(iso);
  if(!isNaN(d)){
    return String(d.getDate()).padStart(2,"0") + "/" +
           String(d.getMonth()+1).padStart(2,"0") + "/" +
           d.getFullYear();
  }
  return iso;
}

function timeToMin(str){
  if(!str) return null;
  const [h,m] = str.split(":").map(Number);
  if(isNaN(h)||isNaN(m)) return null;
  return h*60+m;
}

function formatMin(min){
  if(!min || min <= 0) return "0 min";
  const h = Math.floor(min/60);
  const m = min % 60;
  let out="";
  if(h>0) out += h+"h";
  if(h>0 && m>0) out += " ";
  if(m>0) out += m+"min";
  return out;
}
</script>
<script>
/* ==== TABS ==== */
function setActiveTab(name){
  document.querySelectorAll(".tab").forEach(t=>{
    t.classList.toggle("active", t.dataset.tab === name);
  });
  $("tab-cadastro").style.display  = (name === "cadastro" ? "block" : "none");
  $("tab-emitir").style.display    = (name === "emitir"   ? "block" : "none");
  $("tab-historico").style.display = (name === "historico"? "block" : "none");
}
document.querySelectorAll(".tab").forEach(tab=>{
  tab.addEventListener("click", ()=> setActiveTab(tab.dataset.tab));
});
setActiveTab("emitir");

/* ==== PERFIL ==== */
function getPerfil(){
  try { return JSON.parse(localStorage.getItem("perfilReciboEmpresa") || "{}"); }
  catch(e){ return {}; }
}
function preencherPerfil(){
  const p = getPerfil();
  $("empresa").value   = p.empresa   || "";
  $("cnpj").value      = p.cnpj      || "";
  $("motorista").value = p.motorista || "";
  $("cpf").value       = p.cpf       || "";
  $("marca").value     = p.marca     || "";
  $("modelo").value    = p.modelo    || "";
  $("placa").value     = p.placa     || "";
  $("cor").value       = p.cor       || "";
}
$("savePerfil").addEventListener("click", ()=>{
  const data = {
    empresa:   $("empresa").value,
    cnpj:      $("cnpj").value,
    motorista: $("motorista").value,
    cpf:       $("cpf").value,
    marca:     $("marca").value,
    modelo:    $("modelo").value,
    placa:     $("placa").value,
    cor:       $("cor").value
  };
  localStorage.setItem("perfilReciboEmpresa", JSON.stringify(data));
  alert("Dados salvos!");
});
</script>


<script>
/* ==== FUNCION√ÅRIOS ==== */
const funcionariosContainer = $("funcionariosContainer");

function criarBlocoFuncionario(indice){
  const div = document.createElement("div");
  div.className = "funcionario-block";
  div.innerHTML = `
    <div class="tag-func">Funcion√°rio ${indice}</div>
    <label>Nome</label>
    <input type="text" data-field="nome">
    <label>Empresa</label>
    <input type="text" data-field="empresa">
    <label>Local de embarque</label>
    <input type="text" data-field="local">
    <label>Hor√°rio de embarque</label>
    <input type="time" data-field="hora">
  `;
  return div;
}
function atualizarIndices(){
  document.querySelectorAll(".funcionario-block").forEach((b,i)=>{
    b.querySelector(".tag-func").innerText = "Funcion√°rio " + (i+1);
  });
}
function adicionarFuncionario(){
  const count = document.querySelectorAll(".funcionario-block").length;
  funcionariosContainer.appendChild(criarBlocoFuncionario(count+1));
  atualizarIndices();
}
function removerFuncionario(){
  const blocks = document.querySelectorAll(".funcionario-block");
  if(blocks.length>1){
    blocks[blocks.length-1].remove();
    atualizarIndices();
  }
}
$("addFuncionarioBtn").addEventListener("click", adicionarFuncionario);
$("removerFuncionarioBtn").addEventListener("click", removerFuncionario);

/* garante um */
if(!document.querySelector(".funcionario-block")) adicionarFuncionario();
</script>


<script>
/* ==== LEITURA ==== */
function readDados(){
  const d = {
    empresaDestino:      $("empresaDestino").value,
    empresaResponsavel:  $("empresaResponsavel").value,
    solicitante:         $("solicitante").value,
    horaChegada:         $("horaChegada").value,
    descricao:           $("descricao").value,
    horaInicio:          $("horaInicio").value,
    kmInicial:           $("kmInicial").value,
    horaFim:             $("horaFim").value,
    kmFinal:             $("kmFinal").value,
    valor:               $("valor").value,
    dataViagem:          $("dataViagem").value,
    funcionarios: []
  };

  document.querySelectorAll(".funcionario-block").forEach(block=>{
    const get = f=> block.querySelector(`[data-field="${f}"]`)?.value || "";
    d.funcionarios.push({
      nome:    get("nome"),
      empresa: get("empresa"),
      local:   get("local"),
      hora:    get("hora")
    });
  });
  return d;
}
</script>


<script>
/* ==== C√ÅLCULOS ==== */
function compute(d){
  const ini = timeToMin(d.horaInicio);
  const fim = timeToMin(d.horaFim);
  const chg = timeToMin(d.horaChegada);

  let tempoViagemMin = 0;
  if(ini!=null && fim!=null){
    let diff = fim-ini;
    if(diff<0) diff += 1440;
    tempoViagemMin = diff;
  }

  let baseEspera=0;
  if(ini!=null && chg!=null){
    let diff = ini-chg;
    if(diff<0) diff+=1440;
    baseEspera=diff;
  }

  const tempoEsperaMin = baseEspera;
  const ki = parseFloat(d.kmInicial);
  const kf = parseFloat(d.kmFinal);
  let totalKm = (!isNaN(ki)&&!isNaN(kf)) ? Math.max(0,kf-ki) : null;

  return {
    tempoViagemMin,
    tempoViagemStr: formatMin(tempoViagemMin),
    tempoEsperaStr: formatMin(tempoEsperaMin),
    totalKm
  };
}
function updateUI(){
  const d = compute(readDados());
  $("tempoViagemDisplay").innerText = d.tempoViagemStr;
  $("tempoEsperaDisplay").innerText = d.tempoEsperaStr;
  $("totalKmDisplay").innerText = d.totalKm!=null ? (d.totalKm+" km") : "-";
}
["horaChegada","horaInicio","horaFim","kmInicial","kmFinal"].forEach(id=>{
  $(id).addEventListener("input", updateUI);
});
</script>


<script>
/* ==== HIST√ìRICO ==== */
function renderHistorico(){
  const lista = $("listaRecibos");
  const recs = loadRecibos();
  if(!recs.length){
    lista.innerHTML = "<div style='color:#65707a;font-size:13px'>Nenhum recibo emitido.</div>";
    return;
  }
  lista.innerHTML = recs.map(r=>`
    <div class="hist-item">
      <div>
        <strong>${formatDateBr(r.dataViagem)}</strong><br>
        <span style='font-size:12px;'>${r.empresaDestino||"-"}</span>
      </div>
    </div>
  `).join("");
}
</script>


<script>
/* ==== PDF (PRO somente) ==== */
function gerarPdf(d, perfil, res){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.text("RECIBO DE VIAGEM (Empresa)", 10, 10);
  doc.text("Motorista: "+(perfil.motorista||""),10,20);
  doc.text("Empresa destino: "+(d.empresaDestino||""),10,30);
  doc.text("Data: "+formatDateBr(d.dataViagem),10,40);
  doc.text("Total km: "+(res.totalKm||"-"),10,50);
  doc.save("recibo_empresa.pdf");
}
</script>


<script>
/* ==== EMITIR ==== */
$("emitirPdf").addEventListener("click", ()=>{
  const plano = (localStorage.getItem("planoAtual")||"free").toLowerCase();
  if(plano!=="pro"){ alert("Esta fun√ß√£o √© exclusiva do plano PRO."); return; }

  const perfil = getPerfil();
  const d = readDados();
  const r = compute(d);

  if(!d.empresaDestino){ alert("Informe a empresa de destino."); return; }
  const temFunc = (d.funcionarios||[]).some(f=>f.nome);
  if(!temFunc){ alert("Informe pelo menos um funcion√°rio."); return; }

  gerarPdf(d, perfil, r);

  const recs = loadRecibos();
  recs.unshift({
    id:Date.now(),
    empresaDestino:d.empresaDestino,
    dataViagem:d.dataViagem,
    dados:d
  });
  saveRecibos(recs);
  renderHistorico();
  setActiveTab("historico");
});
</script>


<script>
/* ==== WhatsApp (PRO somente) ==== */
$("enviarWa").addEventListener("click", ()=>{
  const plano = (localStorage.getItem("planoAtual")||"free").toLowerCase();
  if(plano!=="pro"){ alert("Envio por WhatsApp exclusivo do PRO."); return; }

  const d = readDados();
  const msg = `RECIBO EMPRESA
Destino: ${d.empresaDestino||"-"}
Data: ${formatDateBr(d.dataViagem)}
Valor: ${d.valor}`;

  window.open("https://wa.me/?text="+encodeURIComponent(msg));
});
</script>


<script>
/* ==== BOOT ==== */
document.addEventListener("DOMContentLoaded", ()=>{
  preencherPerfil();
  updateUI();
  renderHistorico();
});
</script>
<script>
/* ============================
   EVENTOS DE INPUT (RECALC)
   ============================ */
["horaChegada","horaInicio","horaFim","kmInicial","kmFinal"].forEach(id=>{
  const el = $(id);
  if(el) el.addEventListener("input", updateUI);
});

/* ============================
   BOOT INICIAL
   ============================ */
document.addEventListener("DOMContentLoaded", ()=>{
  // garante pelo menos 1 funcion√°rio
  if(!document.querySelector(".funcionario-block")){
    adicionarFuncionario();
  }
  preencherPerfil();
  updateUI();
  renderHistorico();
});
</script>

</body>
</html>

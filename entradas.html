<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Entradas e Sa√≠das - Motorista App</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

<style>
/* ============================ */
/* PALETA CORPORATIVA GLOBAL    */
/* ============================ */

:root{
    --bg:#ffffff;
    --page-gap:#f3f5f8;

    --card:#fafbfc;
    --card-strong:#f0f2f5;
    --panel:#ffffff;

    --brand:#0b5bd7;
    --brand-dark:#073f8a;

    --accent-success:#1DB954;
    --accent-danger:#ff3b30;

    --text:#0b1115;
    --muted:#65707a;

    --shadow:0 6px 16px rgba(13,30,45,0.07);
    --shadow-strong:0 10px 32px rgba(10,20,30,0.12);

    --radius:14px;
}

/* ============================ */
/*       MODO ESCURO            */
/* ============================ */

.dark{
    --bg:#0f1115;
    --page-gap:#15171c;

    --card:#181a20;
    --card-strong:#1d1f27;
    --panel:#1b1d25;

    --text:#e5e7eb;
    --muted:#9ca3af;

    --brand:#3b82f6;
    --brand-dark:#2563eb;

    --accent-success:#22c55e;
    --accent-danger:#ef4444;
}

/* Remove menu lateral antigo */
.sidebar, .menu-button{ display:none!important; }

/* ============================ */
/* BASE                         */
/* ============================ */

*{ box-sizing:border-box; font-family:Inter,system-ui; }

body{
    margin:0;
    background:linear-gradient(180deg,var(--page-gap),var(--bg) 50%);
    color:var(--text);
    padding-bottom:180px;
    padding-top:70px; /* espa√ßo menu */
}

/* ============================ */
/* MENU SUPERIOR                */
/* ============================ */

.top-menu{
  position:fixed;
  top:0;left:0;width:100%;
  background:var(--panel);
  display:flex;
  padding:6px;
  gap:8px;
  align-items:center;
  z-index:9999;
  overflow-x:auto;
  box-shadow:var(--shadow);
}
.top-menu button{
  padding:10px 14px;
  background:var(--card);
  border:1px solid rgba(0,0,0,0.08);
  border-radius:10px;
  font-weight:700;
  cursor:pointer;
  flex-shrink:0;
  color:var(--text);
}

/* ============================ */
/* HEADER                       */
/* ============================ */

header{
    padding:18px 16px;
    max-width:1080px;
    margin:0 auto;
    display:flex;
    align-items:center;
    justify-content:space-between;
}
.brand{
    display:flex;align-items:center;gap:12px;
}
.brand .logo{
    width:80px;
    height:20px;
    border-radius:12px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:800;
    font-size:13px;
    color:#fff;
    background:linear-gradient(135deg,var(--brand),var(--brand-dark));
    box-shadow:var(--shadow);
}

#toggleTheme{
  background:var(--card-strong);
  padding:8px 12px;
  border-radius:10px;
  cursor:pointer;
  color:var(--text);
  font-weight:700;
}

/* ============================ */
/* CONTAINER                    */
/* ============================ */

.container{
    max-width:980px;
    margin:0 auto;
    padding:0 16px;
}

/* ============================ */
/* TABS                         */
/* ============================ */

.tabs{
    display:flex;
    gap:10px;
    margin-bottom:16px;
}
.tab{
    flex:1;
    text-align:center;
    padding:12px;
    background:var(--card);
    border-radius:var(--radius);
    font-weight:700;
    cursor:pointer;
    color:var(--muted);
    border:1px solid #d7dce2;
    transition:.25s;
}
.tab.active{
    background:linear-gradient(135deg,var(--brand),var(--brand-dark));
    color:#fff;
    border:none;
}

/* ============================ */
/* CARDS                        */
/* ============================ */

.card{
    background:var(--card);
    border-radius:var(--radius);
    padding:20px;
    margin-bottom:25px;
    border:1px solid #d7dce2;
    box-shadow:var(--shadow);
}
.card h3{margin:0 0 12px 0;}

/* ============================ */
/* FORM INPUTS                  */
/* ============================ */

.form input,
.form select{
    width:100%;
    padding:12px;
    border-radius:10px;
    border:1px solid #cfd4da;
    background:var(--panel);
    color:var(--text);
    margin-bottom:12px;
    font-size:15px;
}
button{
    width:17%;
    padding:14px;
    background:linear-gradient(135deg,var(--brand),var(--brand-dark));
    border:none;
    border-radius:10px;
    font-size:13px;
    font-weight:700;
    cursor:pointer;
    color:#fff;
}
.row{display:flex;gap:10px;}
.col{flex:1}

/* ============================ */
/* FILTRO POR PER√çODO           */
/* ============================ */

.period-filters{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    margin-bottom:8px;
}
.period-filters .period-btn{
    width:auto;
    padding:8px 12px;
    font-size:12px;
    border-radius:999px;
    border:1px solid #d7dce2;
    background:var(--panel);
    color:var(--muted);
}
.period-filters .period-btn.active{
    background:linear-gradient(135deg,var(--brand),var(--brand-dark));
    color:#fff;
    border:none;
}
.period-range{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    align-items:center;
}
.period-range label{
    font-size:12px;
    color:var(--muted);
}
.period-range input[type="date"]{
    padding:6px 8px;
    border-radius:8px;
    border:1px solid #cfd4da;
    background:var(--panel);
    font-size:12px;
}
.period-range .period-apply{
    width:auto;
    padding:8px 12px;
    font-size:12px;
}
.period-note{
    display:block;
    margin-top:8px;
    font-size:11px;
    color:var(--muted);
}

/* ============================ */
/* LISTA                        */
/* ============================ */

.item{
    background:var(--card-strong);
    padding:14px;
    border-radius:12px;
    display:flex;
    justify-content:space-between;
    gap:12px;
    margin-bottom:10px;
}
.item small{color:var(--muted);}
.remove{
    background:var(--accent-danger);
    color:#fff;
    border:none;padding:4px 50px;
    border-radius:8px;cursor:pointer;
    font-weight:800;
}
.totals{
    text-align:right;
    font-weight:800;
    margin-bottom:10px;
    color:var(--accent-success);
}

/* ============================ */
/* MODAL                        */
/* ============================ */

#modalMaquineta{
    position:fixed;inset:0;
    background:rgba(0,0,0,0.55);
    display:none;
    z-index:2000;
    padding-top:40px;
}
.modalBox{
    background:var(--card);
    width:92%;max-width:420px;
    padding:20px;border-radius:14px;
    margin:auto;box-shadow:var(--shadow-strong);
}
</style>
</head>

<body>

<!-- MENU SUPERIOR -->
<div class="top-menu">
  <button onclick="location.href='planos.html'">üíé Planos</button>
  <button onclick="location.href='perfil.html'">üë§ Perfil</button>
  <button onclick="location.href='index.html'">üè† Dashboard</button>
  <button onclick="location.href='entradas.html'">üíµ Caixa</button>
  <button onclick="location.href='resumo.html'">üßÆ Resumo</button>
  <button onclick="location.href='recibo_empresa.html'">üè≠ Empresa</button>
  <button onclick="location.href='recibo_particular.html'">üöò Particular</button>
  <button onclick="location.href='manutencao.html'">üõ† Manuten√ß√£o</button>
  <button onclick="location.href='calculadora.html'">üìü Calculadora</button>
</div>

<header>
    <div class="brand">
        <div class="logo">RF Driver</div>
        <h1>cash control</h1>
    </div>
    <button id="toggleTheme">üåô</button>
</header>

<div class="container">

<!-- ============================ -->
<!--          TABS                -->
<!-- ============================ -->

<div class="tabs">
    <div class="tab active" data-tab="corridas">Entradas (Corridas)</div>
    <div class="tab" data-tab="outras">Outras Entradas</div>
    <div class="tab" data-tab="saidas">Sa√≠das (Despesas)</div>
</div>

<!-- ============================ -->
<!--   FORM - ENTRADA CORRIDAS    -->
<!-- ============================ -->

<div class="card" id="form-corridas">
    <h3>Nova Entrada ‚Äî Corrida</h3>
    <div class="form">

        <select id="categoriaEntrada">
            <option value="">Selecione o tipo</option>
            <option value="particular">Viagem Particular</option>
            <option value="empresa">Viagem de Empresa</option>
            <option value="app">Viagem de Aplicativo</option>
        </select>

        <div id="subAppEntrada" style="display:none;">
            <select id="appTipoEntrada">
                <option value="">Selecione o Aplicativo</option>
                <option value="uber">Uber</option>
                <option value="99">99</option>
                <option value="indriver">InDriver</option>
                <option value="outros">Outros</option>
            </select>

            <input id="taxaAppEntrada" type="number" placeholder="Taxa do App (%)">
        </div>

        <input id="descricaoEntrada" type="text" placeholder="Descri√ß√£o da corrida">

        <div class="row">
            <div class="col"><input id="valorBrutoEntrada" type="number" placeholder="Valor bruto (R$)" step="0.01"></div>
            <div class="col"><input id="valorLiquidoEntrada" type="number" placeholder="Valor l√≠quido (R$)" step="0.01"></div>
        </div>

        <select id="formaPagEntrada">
            <option value="">Forma de pagamento</option>
            <option value="dinheiro">Dinheiro</option>
            <option value="pix">PIX</option>
            <option value="appMobile">Pagamento no App</option>
            <option value="cartao">Cart√£o</option>
        </select>

        <div id="cartaoEntrada" style="display:none;">
            <select id="maqEntrada"></select>
            <select id="parcelaEntrada">
                <option value="debito">D√©bito</option>
                <option value="credito_avista">Cr√©dito √† vista</option>
                <option value="2">2x</option>
                <option value="3">3x</option>
                <option value="4">4x</option>
                <option value="5">5x</option>
            </select>
            <button type="button" onclick="abrirCadastroMaquineta()">+ Cadastrar Maquineta</button>
        </div>

        <button type="button" id="btnAdicionarCorrida">Adicionar Corrida</button>

    </div>
</div>

<!-- ============================ -->
<!--   FORM - OUTRAS ENTRADAS     -->
<!-- ============================ -->

<div class="card" id="form-outras" style="display:none;">
    <h3>Nova Entrada ‚Äî Outras</h3>
    <div class="form">

        <input id="descricaoOutra" type="text" placeholder="Descri√ß√£o">

        <div class="row">
            <div class="col">
                <input id="valorBrutoOutra" type="number" placeholder="Valor bruto (R$)" step="0.01">
            </div>
            <div class="col">
                <input id="valorLiquidoOutra" type="number" placeholder="Valor l√≠quido (R$)" step="0.01">
            </div>
        </div>

        <select id="formaPagOutra">
            <option value="">Forma de pagamento</option>
            <option value="dinheiro">Dinheiro</option>
            <option value="pix">PIX</option>
            <option value="appMobile">Pagamento no App</option>
            <option value="cartao">Cart√£o</option>
        </select>

        <div id="cartaoOutra" style="display:none;">
            <select id="maqOutra"></select>
            <select id="parcelaOutra">
                <option value="debito">D√©bito</option>
                <option value="credito_avista">Cr√©dito √† vista</option>
                <option value="2">2x</option>
                <option value="3">3x</option>
                <option value="4">4x</option>
                <option value="5">5x</option>
            </select>
            <button type="button" onclick="abrirCadastroMaquineta()">+ Cadastrar Maquineta</button>
        </div>

        <button type="button" id="btnAdicionarOutra">Adicionar Entrada</button>

    </div>
</div>

<!-- ============================ -->
<!--       FORM - SA√çDAS         -->
<!-- ============================ -->

<div class="card" id="form-saidas" style="display:none;">
    <h3>Nova Sa√≠da</h3>
    <div class="form">

        <input id="descricaoSaida" type="text" placeholder="Descri√ß√£o da despesa">

        <div class="row">
            <div class="col">
                <input id="valorBrutoSaida" type="number" placeholder="Valor (R$)" step="0.01">
            </div>
            <div class="col">
                <select id="formaPagSaida">
                    <option value="">Forma de pagamento</option>
                    <option value="dinheiro">Dinheiro</option>
                    <option value="pix">PIX</option>
                    <option value="cartao">Cart√£o</option>
                </select>
            </div>
        </div>

        <div id="cartaoSaida" style="display:none;">
            <select id="tipoCartaoSaida">
                <option value="debito">D√©bito</option>
                <option value="credito">Cr√©dito</option>
            </select>
        </div>

        <button type="button" id="btnAdicionarSaida">Adicionar Sa√≠da</button>

    </div>
</div>

<!-- ============================ -->
<!--   FILTRO POR PER√çODO        -->
<!-- ============================ -->

<div class="card" id="filtrosPeriodo">
    <h3>Per√≠odo das movimenta√ß√µes</h3>
    <div class="period-filters">
        <button type="button" class="period-btn active" id="btnPeriodoHoje">Hoje</button>
        <button type="button" class="period-btn" id="btnPeriodoSemana">Semana</button>
        <button type="button" class="period-btn" id="btnPeriodoMes">M√™s</button>
        <button type="button" class="period-btn" id="btnPeriodoPersonalizado">Per√≠odo</button>
    </div>
    <div class="period-range" id="periodoPersonalizadoContainer" style="display:none; margin-top:10px;">
        <label>De:
            <input type="date" id="dataInicioFiltro">
        </label>
        <label>At√©:
            <input type="date" id="dataFimFiltro">
        </label>
        <button type="button" id="btnAplicarFiltroDatas" class="period-apply">Aplicar filtro</button>
    </div>
    <small class="period-note" id="legendaPeriodoAtivo">Mostrando movimenta√ß√µes de hoje.</small>
</div>

<!-- ============================ -->
<!--      LISTAS (ENTRADAS)      -->
<!-- ============================ -->

<div class="lists" style="display:flex; gap:16px; flex-wrap:wrap; margin-top:10px;">

    <!-- ENTRADAS -->
    <div class="list-panel" style="flex:1 1 320px; min-width:280px;">
        <div class="card">
            <h3>Entradas (Corridas + Outras)</h3>
            <div id="totalEntradas" class="totals">R$ 0,00</div>
            <div id="listaEntradas"></div>
        </div>
    </div>

    <!-- SA√çDAS -->
    <div class="list-panel" style="flex:1 1 320px; min-width:280px;">
        <div class="card">
            <h3 style="color:var(--accent-danger)">Sa√≠das</h3>
            <div id="totalSaidas" class="totals" style="color:var(--accent-danger)">R$ 0,00</div>
            <div id="listaSaidas"></div>
        </div>
    </div>

</div>

</div> <!-- fecha container -->

<!-- ============================ -->
<!--      MODAL MAQUINETA        -->
<!-- ============================ -->

<div id="modalMaquineta">
    <div class="modalBox">
        <h3 style="margin-top:0;">Cadastrar Maquineta</h3>

        <input id="maqNome" type="text" placeholder="Nome da maquineta">
        <input id="maqDebito" type="number" placeholder="Taxa d√©bito (%)">
        <input id="maqCreditoAvista" type="number" placeholder="Taxa cr√©dito √† vista (%)">
        <input id="maq2x" type="number" placeholder="Taxa 2x (%)">
        <input id="maq3x" type="number" placeholder="Taxa 3x (%)">
        <input id="maq4x" type="number" placeholder="Taxa 4x (%)">
        <input id="maq5x" type="number" placeholder="Taxa 5x (%)">

        <div style="display:flex; gap:10px; margin-top:16px;">
            <button type="button" id="btnSalvarMaquineta">Salvar</button>
            <button type="button" id="btnCancelarMaquineta" style="background:var(--accent-danger);color:#fff;">Cancelar</button>
        </div>
    </div>
</div>

<!-- Menu lateral (mantido escondido para compatibilidade) -->
<div id="sidebar" class="sidebar">
  <span class="menu-close" onclick="closeMenu()">√ó</span>
  <div class="menu-title">Navega√ß√£o</div>
  <div class="menu-item" onclick="location.href='planos.html'">üíé Planos</div>
  <div class="menu-item" onclick="location.href='index.html'">üè† Dashboard</div>
  <div class="menu-item" onclick="location.href='entradas.html'">üíµ Entradas</div>
  <div class="menu-item" onclick="location.href='recibo_empresa.html'">üè≠ Empresa</div>
  <div class="menu-item" onclick="location.href='recibo_particular.html'">üöò Particular</div>
  <div class="menu-item" onclick="location.href='manutencao.html'">üõ† Manuten√ß√£o</div>
  <div class="menu-item" onclick="location.href='resumo.html'">üßÆ Resumo</div>
  <div class="menu-item" onclick="location.href='perfil.html'">üë§ Perfil</div>
  <div class="menu-item" onclick="location.href='calculadora.html'">üìü Calculadora</div>
</div>
<script src="planos.js"></script>

<script>
/* ====================
   THEME (CLARO / ESCURO)
   ==================== */
function applyTheme(theme){
    if(theme === 'dark'){
        document.documentElement.classList.add('dark');
        localStorage.setItem('theme','dark');
        const tbtn = document.getElementById('toggleTheme');
        if(tbtn) tbtn.innerText = '‚òÄÔ∏è';
    } else {
        document.documentElement.classList.remove('dark');
        localStorage.setItem('theme','light');
        const tbtn = document.getElementById('toggleTheme');
        if(tbtn) tbtn.innerText = 'üåô';
    }
}
(function initTheme(){
    const saved = localStorage.getItem('theme') || 'light';
    applyTheme(saved);
    const tbtn = document.getElementById('toggleTheme');
    if(tbtn){
        tbtn.addEventListener('click', ()=>{
            const isDark = document.documentElement.classList.contains('dark');
            applyTheme(isDark ? 'light' : 'dark');
        });
    }
})();

/* ====================
   MENU LATERAL (se usar)
   ==================== */
function openMenu(){
  const sb = document.getElementById("sidebar");
  if(sb) sb.classList.add("open");
}
function closeMenu(){
  const sb = document.getElementById("sidebar");
  if(sb) sb.classList.remove("open");
}

/* ====================
   PLANO ATUAL
   ==================== */
function getPlanoAtualSeguro(){
  try{
    if(typeof getPlano === 'function') return getPlano(); // vindo do planos.js
  }catch(e){}
  return (localStorage.getItem("planoAtual") || "free").toLowerCase();
}
function isPlanoFree(){
  return getPlanoAtualSeguro() === "free";
}

/*
Regras de per√≠odo:
- free:   hoje
- basico: hoje + semana
- premium: hoje + semana + mes + periodo
- pro:    tudo
*/
function bloquearSePlanoNaoPermite(tipoPeriodo){
    const plano = getPlanoAtualSeguro(); // free, basico, premium, pro

    if(tipoPeriodo === 'semana'){
        if(plano === 'free'){
            alert("Recurso de per√≠odo por SEMANA est√° dispon√≠vel a partir do plano B√ÅSICO.");
            window.location.href = "planos.html";
            return true;
        }
    }
    if(tipoPeriodo === 'mes' || tipoPeriodo === 'personalizado'){
        if(plano === 'free' || plano === 'basico'){
            alert("Recurso de per√≠odo por M√äS e PER√çODO personalizado est√° dispon√≠vel a partir do plano PREMIUM.");
            window.location.href = "planos.html";
            return true;
        }
    }
    return false;
}

/* ====================
   STORAGE & STATE
   ==================== */
let registros = JSON.parse(localStorage.getItem('entradasSaidas') || '[]');
let maquinetas = JSON.parse(localStorage.getItem('maquinetas') || '[]');

const $ = id => document.getElementById(id);
const formatBRL = v => Number(v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});

/* ====================
   ESTADO DO PER√çODO
   ==================== */
let periodoAtivo = 'hoje'; // 'hoje' | 'semana' | 'mes' | 'personalizado'
let dataInicioCustom = null;
let dataFimCustom = null;

function normalizarData(d){
    const nd = new Date(d.getFullYear(), d.getMonth(), d.getDate());
    return nd;
}

function passaFiltroPeriodo(reg){
    // se n√£o tiver data salva, n√£o filtra (mant√©m vis√≠vel)
    if(!reg.criadoEm) return true;

    const d = new Date(reg.criadoEm);
    if(isNaN(d.getTime())) return true;

    const hoje = new Date();
    const hojeNorm = normalizarData(hoje);
    const dataNorm = normalizarData(d);

    if(periodoAtivo === 'hoje'){
        return dataNorm.getTime() === hojeNorm.getTime();
    }

    if(periodoAtivo === 'semana'){
        // √∫ltimos 7 dias (incluindo hoje)
        const limite = new Date(hojeNorm);
        limite.setDate(limite.getDate() - 6);
        return dataNorm >= limite && dataNorm <= hojeNorm;
    }

    if(periodoAtivo === 'mes'){
        return (
            d.getFullYear() === hoje.getFullYear() &&
            d.getMonth() === hoje.getMonth()
        );
    }

    if(periodoAtivo === 'personalizado'){
        if(!dataInicioCustom || !dataFimCustom) return true;
        const ini = normalizarData(dataInicioCustom);
        const fim = normalizarData(dataFimCustom);
        return dataNorm >= ini && dataNorm <= fim;
    }

    return true;
}

function atualizarUIPeriodo(){
    const legenda = $('legendaPeriodoAtivo');
    const btnHoje = $('btnPeriodoHoje');
    const btnSemana = $('btnPeriodoSemana');
    const btnMes = $('btnPeriodoMes');
    const btnPers = $('btnPeriodoPersonalizado');
    const contPers = $('periodoPersonalizadoContainer');

    [btnHoje, btnSemana, btnMes, btnPers].forEach(btn=>{
        if(!btn) return;
        btn.classList.remove('active');
    });

    if(periodoAtivo === 'hoje' && btnHoje) btnHoje.classList.add('active');
    if(periodoAtivo === 'semana' && btnSemana) btnSemana.classList.add('active');
    if(periodoAtivo === 'mes' && btnMes) btnMes.classList.add('active');
    if(periodoAtivo === 'personalizado' && btnPers) btnPers.classList.add('active');

    if(contPers){
        contPers.style.display = periodoAtivo === 'personalizado' ? 'flex' : 'none';
    }

    if(legenda){
        if(periodoAtivo === 'hoje') legenda.innerText = "Mostrando movimenta√ß√µes de hoje.";
        if(periodoAtivo === 'semana') legenda.innerText = "Mostrando movimenta√ß√µes dos √∫ltimos 7 dias.";
        if(periodoAtivo === 'mes') legenda.innerText = "Mostrando movimenta√ß√µes do m√™s atual.";
        if(periodoAtivo === 'personalizado') legenda.innerText = "Mostrando movimenta√ß√µes no per√≠odo selecionado.";
    }
}

function setPeriodo(tipo){
    if(tipo === 'semana' || tipo === 'mes' || tipo === 'personalizado'){
        if(bloquearSePlanoNaoPermite(tipo)) return;
    }
    periodoAtivo = tipo;
    atualizarUIPeriodo();
    mostrarListas();
}

function aplicarFiltroPersonalizado(){
    if(bloquearSePlanoNaoPermite('personalizado')) return;

    const iniValue = $('dataInicioFiltro')?.value;
    const fimValue = $('dataFimFiltro')?.value;

    if(!iniValue || !fimValue){
        alert("Selecione a data inicial e a data final.");
        return;
    }
    const ini = new Date(iniValue + 'T00:00:00');
    const fim = new Date(fimValue + 'T23:59:59');
    if(ini > fim){
        alert("A data inicial n√£o pode ser maior que a data final.");
        return;
    }

    dataInicioCustom = ini;
    dataFimCustom = fim;
    periodoAtivo = 'personalizado';
    atualizarUIPeriodo();
    mostrarListas();
}

/* ====================
   TABS + REGRAS DE PLANO
   ==================== */
function setActiveTab(name){
    // Regra de plano: FREE s√≥ pode "corridas"
    if(isPlanoFree() && (name === 'outras' || name === 'saidas')){
        alert("No plano FREE, apenas a aba 'Entradas (Corridas)' est√° liberada. Atualize seu plano para liberar todas as fun√ß√µes.");
        window.location.href = "planos.html";
        return;
    }

    document.querySelectorAll('.tab').forEach(t=>{
        t.classList.toggle('active', t.getAttribute('data-tab') === name);
    });
    $('form-corridas').style.display = name === 'corridas' ? 'block' : 'none';
    $('form-outras').style.display = name === 'outras' ? 'block' : 'none';
    $('form-saidas').style.display = name === 'saidas' ? 'block' : 'none';
}

document.querySelectorAll('.tab').forEach(t => {
    t.addEventListener('click', ()=> setActiveTab(t.getAttribute('data-tab')));
});

/* For√ßa aba padr√£o e aplica restri√ß√£o inicial */
function aplicarRegrasPlanoCaixa(){
    setActiveTab('corridas'); // sempre come√ßa em corridas
    // Se free, mantemos os formul√°rios de outras/sa√≠das escondidos.
    if(isPlanoFree()){
        if($('form-outras')) $('form-outras').style.display = 'none';
        if($('form-saidas')) $('form-saidas').style.display = 'none';
    }
}

/* ====================
   MAQUINETAS (modal)
   ==================== */
function abrirCadastroMaquineta(){
    const m = $('modalMaquineta');
    if(m){
        m.style.display='block';
        m.setAttribute('aria-hidden','false');
    }
}
function fecharCadastroMaquineta(){
    const m = $('modalMaquineta');
    if(m){
        m.style.display='none';
        m.setAttribute('aria-hidden','true');
    }
}

function persistMaquinetas(){ localStorage.setItem('maquinetas', JSON.stringify(maquinetas)); }
function persist(){ localStorage.setItem('entradasSaidas', JSON.stringify(registros)); }

function atualizarMaquinetas(selectId){
    const sel = $(selectId);
    if(!sel) return;
    sel.innerHTML = '';
    for(let i=0;i<maquinetas.length;i++){
        const m = maquinetas[i];
        const opt = document.createElement('option');
        opt.value = i;
        opt.text = m.nome;
        sel.appendChild(opt);
    }
}

/* salvar maquineta */
$('btnSalvarMaquineta')?.addEventListener('click', ()=>{
    const nome = $('maqNome')?.value?.trim();
    if(!nome){ alert('Informe o nome da maquineta'); return; }
    const m = {
        nome,
        debito: Number($('maqDebito')?.value) || 0,
        credito_avista: Number($('maqCreditoAvista')?.value) || 0,
        "2": Number($('maq2x')?.value) || 0,
        "3": Number($('maq3x')?.value) || 0,
        "4": Number($('maq4x')?.value) || 0,
        "5": Number($('maq5x')?.value) || 0
    };
    maquinetas.push(m);
    persistMaquinetas();
    atualizarMaquinetas('maqEntrada');
    atualizarMaquinetas('maqOutra');
    atualizarMaquinetas('maqSaida');
    fecharCadastroMaquineta();
    ['maqNome','maqDebito','maqCreditoAvista','maq2x','maq3x','maq4x','maq5x'].forEach(id=>{ if($(id)) $(id).value = ''; });
});
$('btnCancelarMaquineta')?.addEventListener('click', ()=> fecharCadastroMaquineta());

/* ====================
   C√ÅLCULO L√çQUIDO / MAQUINETA
   ==================== */
function calcularLiquidoParaMaquineta(bruto, index, parcela){
    bruto = Number(bruto) || 0;
    if(index === null || index === undefined || index === '') return bruto;
    const m = maquinetas[index];
    if(!m) return bruto;
    let taxa = 0;
    if(parcela === 'debito') taxa = Number(m.debito || 0);
    else if(parcela === 'credito_avista') taxa = Number(m.credito_avista || 0);
    else taxa = Number(m[parcela] || 0);
    return +(bruto - (bruto * (taxa/100)));
}

/* ====================
   CORRIDA (form)
   ==================== */
$('categoriaEntrada')?.addEventListener('change', ()=> {
    const cat = $('categoriaEntrada').value;
    if($('subAppEntrada')) $('subAppEntrada').style.display = cat === 'app' ? 'block' : 'none';
    recalcCorrida();
});

$('formaPagEntrada')?.addEventListener('change', ()=>{
    const forma = $('formaPagEntrada').value;
    if($('cartaoEntrada')) $('cartaoEntrada').style.display = forma === 'cartao' ? 'block' : 'none';
    if(forma === 'cartao') atualizarMaquinetas('maqEntrada');
});

function recalcCorrida(){
    const bruto = Number($('valorBrutoEntrada')?.value) || 0;
    let liquido = bruto;
    if($('categoriaEntrada') && $('categoriaEntrada').value === 'app'){
        const taxa = Number($('taxaAppEntrada')?.value) || 0;
        liquido -= bruto * (taxa/100);
    }
    if($('formaPagEntrada') && $('formaPagEntrada').value === 'cartao'){
        const index = $('maqEntrada') ? $('maqEntrada').value : null;
        const par = $('parcelaEntrada') ? $('parcelaEntrada').value : null;
        liquido = calcularLiquidoParaMaquineta(bruto, index, par);
    }
    if(!isFinite(liquido)) liquido = bruto;
    if($('valorLiquidoEntrada')) $('valorLiquidoEntrada').value = liquido.toFixed(2);
}

$('valorBrutoEntrada')?.addEventListener('input', recalcCorrida);
$('taxaAppEntrada')?.addEventListener('input', recalcCorrida);
$('parcelaEntrada')?.addEventListener('change', recalcCorrida);

$('btnAdicionarCorrida')?.addEventListener('click', ()=>{
    const categoria = $('categoriaEntrada')?.value;
    const descricao = ($('descricaoEntrada')?.value||'').trim();
    const bruto = Number($('valorBrutoEntrada')?.value);
    if(!categoria){ alert('Selecione o tipo de entrada.'); return; }
    if(!descricao){ alert('Preencha a descri√ß√£o.'); return; }
    if(!bruto || bruto <= 0){ alert('Informe um valor bruto v√°lido.'); return; }
    recalcCorrida();
    const liquido = Number($('valorLiquidoEntrada')?.value) || bruto;
    const registro = {
        id: Date.now(),
        tipo: 'entrada',
        subtipo: 'corrida',
        categoria: categoria,
        appTipo: $('appTipoEntrada')?.value || null,
        formaPag: $('formaPagEntrada')?.value || null,
        maquinetaIndex: ($('maqEntrada')? $('maqEntrada').value : null),
        valorBruto: bruto,
        valor: liquido,
        descricao,
        criadoEm: new Date().toISOString()
    };
    registros.unshift(registro);
    persist();
    mostrarListas();
    limparFormCorrida();
});

/* ====================
   OUTRAS (form)
   ==================== */
$('formaPagOutra')?.addEventListener('change', ()=>{
    const forma = $('formaPagOutra')?.value;
    if($('cartaoOutra')) $('cartaoOutra').style.display = forma === 'cartao' ? 'block' : 'none';
    if(forma === 'cartao') atualizarMaquinetas('maqOutra');
});

function recalcOutra(){
    const bruto = Number($('valorBrutoOutra')?.value) || 0;
    let liquido = bruto;
    if($('formaPagOutra') && $('formaPagOutra').value === 'cartao'){
        const index = $('maqOutra') ? $('maqOutra').value : null;
        const par = $('parcelaOutra') ? $('parcelaOutra').value : null;
        liquido = calcularLiquidoParaMaquineta(bruto, index, par);
    }
    if(!isFinite(liquido)) liquido = bruto;
    if($('valorLiquidoOutra')) $('valorLiquidoOutra').value = liquido.toFixed(2);
}
$('valorBrutoOutra')?.addEventListener('input', recalcOutra);
$('parcelaOutra')?.addEventListener('change', recalcOutra);

$('btnAdicionarOutra')?.addEventListener('click', ()=>{
    const descricao = ($('descricaoOutra')?.value||'').trim();
    const bruto = Number($('valorBrutoOutra')?.value);
    if(!descricao){ alert('Preencha a descri√ß√£o da entrada.'); return; }
    if(!bruto || bruto <= 0){ alert('Informe um valor bruto v√°lido.'); return; }
    recalcOutra();
    const liquido = Number($('valorLiquidoOutra')?.value) || bruto;
    const registro = {
        id: Date.now(),
        tipo: 'entrada',
        subtipo: 'outra',
        categoria: null,
        appTipo: null,
        formaPag: $('formaPagOutra')?.value || null,
        maquinetaIndex: ($('maqOutra')? $('maqOutra').value : null),
        valorBruto: bruto,
        valor: liquido,
        descricao,
        criadoEm: new Date().toISOString()
    };
    registros.unshift(registro);
    persist();
    mostrarListas();
    limparFormOutra();
});

/* ====================
   SA√çDAS (form)
   ==================== */
$('formaPagSaida')?.addEventListener('change', ()=>{
    const forma = $('formaPagSaida')?.value;
    if($('cartaoSaida')) $('cartaoSaida').style.display = forma === 'cartao' ? 'block' : 'none';
});

$('btnAdicionarSaida')?.addEventListener('click', ()=>{
    const descricao = ($('descricaoSaida')?.value||'').trim();
    const bruto = Number($('valorBrutoSaida')?.value);
    if(!descricao){ alert('Preencha a descri√ß√£o da sa√≠da.'); return; }
    if(!bruto || bruto <= 0){ alert('Informe um valor v√°lido para a sa√≠da.'); return; }
    const registro = {
        id: Date.now(),
        tipo: 'saida',
        descricao,
        valor: bruto,
        formaPag: $('formaPagSaida')?.value || null,
        tipoCartao: ($('tipoCartaoSaida')? $('tipoCartaoSaida').value : null),
        criadoEm: new Date().toISOString()
    };
    registros.unshift(registro);
    persist();
    mostrarListas();
    limparFormSaida();
});

/* ====================
   LISTAGEM / RENDER
   ==================== */
function escapeHtml(text){
    if(!text) return '';
    return String(text)
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,"&#039;");
}

function mostrarListas(){
    const listaE = $('listaEntradas');
    const listaS = $('listaSaidas');
    if(!listaE || !listaS) return;
    listaE.innerHTML = '';
    listaS.innerHTML = '';

    let totalBrutoEntradas = 0;
    let totalSaidas = 0;

    const filtrados = registros.filter(passaFiltroPeriodo);

    filtrados.forEach(r=>{
        const div = document.createElement('div');
        div.className = 'item';

        if(r.tipo === 'entrada'){
            let detalhe = r.subtipo ? (r.subtipo === 'corrida' ? `Corrida ‚Ä¢ ${r.categoria || ''}` : 'Outra entrada') : '';
            if(r.appTipo) detalhe += ` ‚Ä¢ ${r.appTipo}`;
            if(r.formaPag) detalhe += ` ‚Ä¢ ${r.formaPag}`;

            div.innerHTML = `
                <div>
                    <strong style="display:block">${escapeHtml(r.descricao)}</strong>
                    <small>${escapeHtml(detalhe)}</small>
                    <small>Bruto: ${formatBRL(r.valorBruto)} ${r.valor ? `‚Ä¢ L√≠quido: ${formatBRL(r.valor)}` : ''}</small>
                </div>
                <div style="text-align:right; min-width:120px;">
                    <div style="margin-bottom:8px">${formatBRL(r.valorBruto)}</div>
                    <div><button class="remove" onclick="remover(${r.id})">Excluir</button></div>
                </div>
            `;
            listaE.appendChild(div);
            totalBrutoEntradas += Number(r.valorBruto || 0);
        } else {
            let detalhe = r.formaPag ? `${r.formaPag}` : '';
            if(r.tipoCartao) detalhe += ` ‚Ä¢ ${r.tipoCartao}`;
            div.innerHTML = `
                <div>
                    <strong style="display:block">${escapeHtml(r.descricao)}</strong>
                    <small>${escapeHtml(detalhe)}</small>
                </div>
                <div style="text-align:right; min-width:120px;">
                    <div style="margin-bottom:8px">${formatBRL(r.valor)}</div>
                    <div><button class="remove" onclick="remover(${r.id})">Excluir</button></div>
                </div>
            `;
            listaS.appendChild(div);
            totalSaidas += Number(r.valor || 0);
        }
    });

    $('totalEntradas').innerText = formatBRL(totalBrutoEntradas);
    $('totalSaidas').innerText = formatBRL(totalSaidas);
}

/* ====================
   REMOVER
   ==================== */
function remover(id){
    if(!confirm('Excluir este registro?')) return;
    registros = registros.filter(r => r.id !== id);
    persist();
    mostrarListas();
}

/* ====================
   LIMPA FORMUL√ÅRIOS
   ==================== */
function limparFormCorrida(){
    if($('categoriaEntrada')) $('categoriaEntrada').value = '';
    if($('appTipoEntrada')) $('appTipoEntrada').value = '';
    if($('taxaAppEntrada')) $('taxaAppEntrada').value = '';
    if($('descricaoEntrada')) $('descricaoEntrada').value = '';
    if($('valorBrutoEntrada')) $('valorBrutoEntrada').value = '';
    if($('valorLiquidoEntrada')) $('valorLiquidoEntrada').value = '';
    if($('formaPagEntrada')) $('formaPagEntrada').value = '';
    if($('cartaoEntrada')) $('cartaoEntrada').style.display = 'none';
}

function limparFormOutra(){
    if($('descricaoOutra')) $('descricaoOutra').value = '';
    if($('valorBrutoOutra')) $('valorBrutoOutra').value = '';
    if($('valorLiquidoOutra')) $('valorLiquidoOutra').value = '';
    if($('formaPagOutra')) $('formaPagOutra').value = '';
    if($('cartaoOutra')) $('cartaoOutra').style.display = 'none';
}

function limparFormSaida(){
    if($('descricaoSaida')) $('descricaoSaida').value = '';
    if($('valorBrutoSaida')) $('valorBrutoSaida').value = '';
    if($('formaPagSaida')) $('formaPagSaida').value = '';
    if($('cartaoSaida')) $('cartaoSaida').style.display = 'none';
}

/* ====================
   BOOT
   ==================== */
(function boot(){
    registros = JSON.parse(localStorage.getItem('entradasSaidas') || '[]');
    maquinetas = JSON.parse(localStorage.getItem('maquinetas') || '[]');

    atualizarMaquinetas('maqEntrada');
    atualizarMaquinetas('maqOutra');
    atualizarMaquinetas('maqSaida');

    // listeners dos bot√µes de per√≠odo
    $('btnPeriodoHoje')?.addEventListener('click', ()=> setPeriodo('hoje'));
    $('btnPeriodoSemana')?.addEventListener('click', ()=> setPeriodo('semana'));
    $('btnPeriodoMes')?.addEventListener('click', ()=> setPeriodo('mes'));
    $('btnPeriodoPersonalizado')?.addEventListener('click', ()=> setPeriodo('personalizado'));
    $('btnAplicarFiltroDatas')?.addEventListener('click', aplicarFiltroPersonalizado);

    atualizarUIPeriodo();
    mostrarListas();
    aplicarRegrasPlanoCaixa();

    // fecha modal ao clicar fora da caixa
    document.getElementById('modalMaquineta')?.addEventListener('click', (e)=>{
        if(e.target && e.target.id === 'modalMaquineta') fecharCadastroMaquineta();
    });
})();
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Recibo - Fluxo Driver</title>

<!-- FONT -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
/* ============================ */
/*     PALETA CORPORATIVA       */
/* ============================ */
:root{
    --bg:#ffffff;
    --page-gap:#f3f5f8;

    --card:#fafbfc;
    --card-strong:#f0f2f5;
    --panel:#ffffff;

    --brand:#0b5bd7;
    --brand-dark:#073f8a;

    --text:#0b1115;
    --muted:#65707a;

    --shadow:0 6px 16px rgba(13,30,45,0.07);
    --shadow-strong:0 10px 32px rgba(10,20,30,0.12);

    --radius:14px;
}

/* DARK */
.dark{
    --bg:#0f1115;
    --page-gap:#15171c;

    --card:#181a20;
    --card-strong:#1d1f27;
    --panel:#1b1d25;

    --text:#e5e7eb;
    --muted:#9ca3af;

    --shadow:0 6px 16px rgba(0,0,0,0.35);
    --shadow-strong:0 10px 32px rgba(0,0,0,0.45);

    --brand:#3b82f6;
    --brand-dark:#2563eb;
}

/* BASE */
*{box-sizing:border-box;}
body{
    margin:0;
    font-family:Inter,Roboto,Arial,sans-serif;
    background:linear-gradient(180deg,var(--page-gap),var(--bg) 50%);
    color:var(--text);
    padding-bottom:160px;
}

/* HEADER */
header{
    padding:18px 16px;
    max-width:980px;
    margin:0 auto 10px;
    display:flex;
    align-items:center;
    justify-content:space-between;
}
.brand{display:flex;align-items:center;gap:12px;}
.brand .logo{
    width:46px;height:46px;border-radius:12px;
    display:flex;align-items:center;justify-content:center;
    font-weight:800;color:#fff;font-size:18px;
    background:linear-gradient(135deg,var(--brand),var(--brand-dark));
    box-shadow:var(--shadow);
}
#toggleTheme{
    background:var(--card-strong);
    padding:8px 12px;border-radius:10px;
    border:1px solid rgba(0,0,0,.15);
    font-weight:700;color:var(--text);
    cursor:pointer;
}

.container{
    max-width:980px;margin:0 auto;padding:0 16px;
}

/* CARD */
.card{
    background:var(--card);
    border-radius:var(--radius);
    padding:20px;
    margin-bottom:18px;
    border:1px solid #d7dce2;
    box-shadow:var(--shadow);
}
.card h3{
    margin-top:0;
    margin-bottom:10px;
    font-size:17px;
}
.card label{
    display:block;margin:8px 0 4px;font-size:14px;color:var(--muted);
}
.card input,
.card textarea,
.card select{
    width:100%;padding:12px;border-radius:10px;
    border:1px solid #cfd4da;background:var(--panel);
    font-size:15px;margin-bottom:8px;
    color:var(--text);
}
.card textarea{resize:vertical;min-height:70px;}

/* LINHAS / GRID */
.row{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
}
.col{
    flex:1;
    min-width:150px;
}

/* RESUMO LATERAL (totais) */
.resumo-linha{
    display:flex;
    justify-content:space-between;
    align-items:center;
    font-size:14px;
    color:var(--muted);
    margin-top:4px;
}
.resumo-linha strong{color:var(--text);}

/* FUNCION√ÅRIOS */
.funcionario-block{
    background:var(--card-strong);
    border-radius:12px;
    padding:12px;
    border:1px solid #d7dce2;
    margin-top:10px;
}
.tag-func{
    display:inline-block;
    padding:2px 10px;
    border-radius:999px;
    background:rgba(11,91,215,0.08);
    color:var(--brand-dark);
    font-size:12px;
    font-weight:700;
    margin-bottom:6px;
}
.dark .funcionario-block{
    border-color:#292c33;
}
.atraso-extra{
    margin-top:4px;
}

/* BOT√ïES */
.card button{
    width:100%;padding:14px;border:none;
    border-radius:10px;font-size:15px;font-weight:700;
    background:linear-gradient(135deg,var(--brand),var(--brand-dark));
    color:#fff;cursor:pointer;margin-top:10px;
}
.card .btn-inline{
    width:auto;
    flex:1;
    padding:10px 12px;
    font-size:13px;
}
.card .btn-secondary{
    background:#9ca3af;
    color:#111827;
}
.card .btn-sm{
    width:auto;
    padding:8px 10px;
    font-size:13px;
}

/* HIST√ìRICO */
.hist-item{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:10px;
    margin-top:8px;
    border-radius:10px;
    background:var(--card-strong);
}
.hist-item .actions{
    display:flex;
    gap:6px;
}

/* MENU NEO */
.neo-menu{
  backdrop-filter:blur(10px);
  background:rgba(10,20,35,.55);
  border:1px solid rgba(255,255,255,.1);
  border-radius:18px;
  padding:12px 0;
  position:fixed;bottom:20px;left:50%;
  transform:translateX(-50%);
  width:92%;max-width:980px;
  display:flex;justify-content:space-around;
  box-shadow:0 18px 40px rgba(0,0,0,.35);
  z-index:2000;
}
.neo-menu .menu-item{
  text-decoration:none;color:#fff;font-weight:700;
  font-size:12px;display:flex;flex-direction:column;
  align-items:center;gap:3px;opacity:.75;transition:.25s;
}
.neo-menu .menu-item .icon{font-size:20px;}
.neo-menu .menu-item.active{
  opacity:1;transform:scale(1.15);
}
body.dark .neo-menu{
  background:rgba(25,25,30,0.65);
  border-color:rgba(255,255,255,0.05);
}
</style>
</head>

<body>

<script src="planos.js"></script>

<header>
  <div class="brand">
      <div class="logo">RF</div>
      <h2 style="margin:0;">Recibo</h2>
  </div>
  <button id="toggleTheme">üåô</button>
</header>

<div class="container">

  <!-- CADASTRO FIXO PARA RECIBO (EMPRESA + MOTORISTA) -->
  <h2>Cadastro para Recibo</h2>
  <div class="card">
    <h3>Dados da empresa / motorista</h3>
    <label>Empresa (opcional)</label><input id="empresa">
    <label>CNPJ (opcional)</label><input id="cnpj">
    <label>Nome do Motorista *</label><input id="motorista">
    <label>CPF ou RG *</label><input id="cpf">
    <label>Marca *</label><input id="marca">
    <label>Modelo *</label><input id="modelo">
    <label>Placa *</label><input id="placa">
    <label>Cor *</label><input id="cor">
    <button id="savePerfil">Salvar Dados</button>
  </div>

  <!-- EMISS√ÉO DO RECIBO -->
  <h2>Emitir Recibo</h2>
  <div class="card">

    <h3>Dados b√°sicos da viagem</h3>
    <label>Empresa de destino</label>
    <input id="empresaDestino">

    <label>Empresa respons√°vel pelos funcion√°rios</label>
    <input id="empresaResponsavel">

    <label>Solicitante da Viagem</label>
    <input id="solicitante">

    <label>Hor√°rio de chegada no ponto de embarque / coleta</label>
    <input id="horaChegada" type="time">

    <label>Descri√ß√£o sobre a viagem / Tipo de servi√ßo</label>
    <textarea id="descricao"></textarea>

    <hr style="margin:18px 0;border:none;border-top:1px solid #d7dce2;"/>

    <h3>Funcion√°rios</h3>
    <div id="funcionariosContainer"></div>
    <div class="row" style="margin-top:6px;">
      <button type="button" id="addFuncionarioBtn" class="btn-inline">‚ûï Adicionar funcion√°rio</button>
      <button type="button" id="removerFuncionarioBtn" class="btn-inline btn-secondary">‚ûñ Remover funcion√°rio</button>
    </div>

    <hr style="margin:18px 0;border:none;border-top:1px solid #d7dce2;"/>

    <h3>Hor√°rios & Quilometragem</h3>
    <div class="row">
      <div class="col">
        <label>Hor√°rio inicial</label>
        <input id="horaInicio" type="time">
      </div>
      <div class="col">
        <label>KM inicial</label>
        <input id="kmInicial" type="number" step="0.1">
      </div>
    </div>
    <div class="row">
      <div class="col">
        <label>Hor√°rio final</label>
        <input id="horaFim" type="time">
      </div>
      <div class="col">
        <label>KM final</label>
        <input id="kmFinal" type="number" step="0.1">
      </div>
    </div>

    <div style="margin-top:8px;">
      <div class="resumo-linha">
        <span>Total de KM</span>
        <strong id="totalKmDisplay">-</strong>
      </div>
      <div class="resumo-linha">
        <span>Tempo de espera</span>
        <strong id="tempoEsperaDisplay">0 min</strong>
      </div>
      <div class="resumo-linha">
        <span>Tempo de viagem</span>
        <strong id="tempoViagemDisplay">0 min</strong>
      </div>
    </div>

    <hr style="margin:18px 0;border:none;border-top:1px solid #d7dce2;"/>

    <h3>Resumo financeiro</h3>
    <label>Valor total da viagem (R$)</label>
    <input id="valor" type="number" step="0.01">

    <label>Data da viagem</label>
    <input id="dataViagem" type="date">

    <button id="emitirPdf">Gerar PDF</button>
    <button id="enviarWa" style="background:#128c7e">Enviar WhatsApp</button>
  </div>

  <!-- HIST√ìRICO DE RECIBOS -->
  <div class="card">
    <h3>Hist√≥rico de recibos</h3>
    <div id="listaRecibos" class="small"></div>
  </div>

</div>

<!-- MENU INFERIOR -->
<nav class="neo-menu">
  <a href="planos.html" class="menu-item"><span class="icon">‚≠ê</span><span>Planos</span></a>
  <a href="index.html" class="menu-item"><span class="icon">üè†</span><span>Dashboard</span></a>
  <a href="entradas.html" class="menu-item"><span class="icon">üíµ</span><span>Entradas</span></a>
  <a href="recibo.html" class="menu-item active"><span class="icon">üßæ</span><span>Recibo</span></a>
  <a href="manutencao.html" class="menu-item"><span class="icon">üõ†</span><span>Manut.</span></a>
  <a href="resumo.html" class="menu-item"><span class="icon">üìä</span><span>Resumo</span></a>
  <a href="perfil.html" class="menu-item"><span class="icon">üë§</span><span>Perfil</span></a>
  <a href="calculadora.html" class="menu-item"><span class="icon">üìü</span><span>Calc</span></a>
</nav>

<script>
/* THEME */
function applyTheme(theme){
    if(theme === "dark"){
        document.documentElement.classList.add("dark");
        localStorage.setItem("theme","dark");
        document.getElementById("toggleTheme").innerText = "‚òÄÔ∏è";
    } else {
        document.documentElement.classList.remove("dark");
        localStorage.setItem("theme","light");
        document.getElementById("toggleTheme").innerText = "üåô";
    }
}
applyTheme(localStorage.getItem("theme")||"light");
document.getElementById("toggleTheme").onclick = ()=>{
    const isDark=document.documentElement.classList.contains("dark");
    applyTheme(isDark?"light":"dark");
};

/* PERMISS√ÉO */
if(!planoTem("reciboComMotorista")){
    alert("Este recurso est√° dispon√≠vel apenas no Plano PRO.");
    location.href="planos.html";
}
</script>

<script>
/* PERFIL FIXO (empresa + motorista) */
document.getElementById("savePerfil").onclick = ()=>{
    const data={
        empresa:empresa.value,
        cnpj:cnpj.value,
        motorista:motorista.value,
        cpf:cpf.value,
        marca:marca.value,
        modelo:modelo.value,
        placa:placa.value,
        cor:cor.value
    };
    localStorage.setItem("perfilRecibo",JSON.stringify(data));
    alert("Dados salvos!");
};
function getPerfil(){return JSON.parse(localStorage.getItem("perfilRecibo")||"{}");}

/* HELPERS GERAIS */
const $ = id => document.getElementById(id);
const RECIBOS_KEY = 'recibosViagem';

function loadRecibos(){
  try{return JSON.parse(localStorage.getItem(RECIBOS_KEY)||'[]');}
  catch(e){return [];}
}
function saveRecibos(list){
  localStorage.setItem(RECIBOS_KEY, JSON.stringify(list));
}
function formatDateBr(iso){
  if(!iso) return '-';
  const d = new Date(iso);
  if(!isNaN(d)){
    const dd=String(d.getDate()).padStart(2,'0');
    const mm=String(d.getMonth()+1).padStart(2,'0');
    const yy=d.getFullYear();
    return dd+'/'+mm+'/'+yy;
  }
  if(/^\d{4}-\d{2}-\d{2}$/.test(iso)){
    const [y,m,da]=iso.split('-');
    return da+'/'+m+'/'+y;
  }
  return iso;
}
function timeToMin(str){
  if(!str) return null;
  const parts=str.split(':');
  if(parts.length<2) return null;
  const h=parseInt(parts[0],10), m=parseInt(parts[1],10);
  if(isNaN(h)||isNaN(m)) return null;
  return h*60+m;
}
function formatMin(min){
  if(!min || min<=0) return '0 min';
  const h=Math.floor(min/60);
  const m=min%60;
  let out='';
  if(h>0) out+=h+'h';
  if(h>0 && m>0) out+=' ';
  if(m>0) out+=m+'min';
  return out;
}

/* FUNCION√ÅRIOS DIN√ÇMICOS */
const funcionariosContainer = $('funcionariosContainer');

function criarBlocoFuncionario(indice){
  const div=document.createElement('div');
  div.className='funcionario-block';
  div.innerHTML = `
    <div class="tag-func">Funcion√°rio ${indice}</div>
    <label>Nome</label>
    <input type="text" data-field="nome">
    <label>Empresa</label>
    <input type="text" data-field="empresa">
    <label>Local de embarque</label>
    <input type="text" data-field="local">
    <label>Hor√°rio de embarque</label>
    <input type="time" data-field="hora">
    <label>Houve atraso?</label>
    <select data-field="atraso">
      <option value="nao">N√£o</option>
      <option value="sim">Sim</option>
    </select>
    <div class="atraso-extra" style="display:none;">
      <label>Minutos de atraso</label>
      <input type="number" data-field="minAtraso" min="0" step="1">
    </div>
  `;
  const selectAtraso = div.querySelector('select[data-field="atraso"]');
  const caixaAtraso = div.querySelector('.atraso-extra');
  const horaEmb = div.querySelector('input[data-field="hora"]');
  const minAtraso = div.querySelector('input[data-field="minAtraso"]');

  selectAtraso.addEventListener('change',()=>{
    caixaAtraso.style.display = selectAtraso.value==='sim' ? 'block':'none';
    recomputeDerivedUI();
  });
  horaEmb.addEventListener('change',recomputeDerivedUI);
  minAtraso.addEventListener('input',recomputeDerivedUI);

  return div;
}
function atualizarIndicesFuncionarios(){
  document.querySelectorAll('.funcionario-block').forEach((block,idx)=>{
    const tag=block.querySelector('.tag-func');
    if(tag) tag.textContent='Funcion√°rio '+(idx+1);
  });
}
function adicionarFuncionario(){
  const count=document.querySelectorAll('.funcionario-block').length;
  const block=criarBlocoFuncionario(count+1);
  funcionariosContainer.appendChild(block);
  atualizarIndicesFuncionarios();
}
function removerFuncionario(){
  const blocks=document.querySelectorAll('.funcionario-block');
  if(blocks.length>1){
    blocks[blocks.length-1].remove();
    atualizarIndicesFuncionarios();
    recomputeDerivedUI();
  }
}

/* LER DADOS DO FORMUL√ÅRIO */
function readDadosFromDOM(){
  const dados = {
    empresaDestino: $('empresaDestino').value.trim(),
    empresaResponsavel: $('empresaResponsavel').value.trim(),
    solicitante: $('solicitante').value.trim(),
    horaChegada: $('horaChegada').value,
    descricao: $('descricao').value.trim(),
    valor: $('valor').value,
    dataViagem: $('dataViagem').value,
    horaInicio: $('horaInicio').value,
    kmInicial: $('kmInicial').value,
    horaFim: $('horaFim').value,
    kmFinal: $('kmFinal').value,
    funcionarios: []
  };
  document.querySelectorAll('.funcionario-block').forEach(block=>{
    const get = f => (block.querySelector('[data-field="'+f+'"]')||{}).value || '';
    dados.funcionarios.push({
      nome: get('nome').trim(),
      empresa: get('empresa').trim(),
      local: get('local').trim(),
      horaEmbarque: get('hora').trim(),
      atraso: get('atraso'),
      minutosAtraso: Number(get('minAtraso')) || 0
    });
  });
  return dados;
}

/* C√ÅLCULOS DERIVADOS */
function computeDerivedFromData(d){
  const ini = timeToMin(d.horaInicio);
  const fim = timeToMin(d.horaFim);
  const chegada = timeToMin(d.horaChegada);

  let tempoViagemMin = 0;
  if(ini!=null && fim!=null){
    let diff = fim - ini;
    if(diff<0) diff += 24*60;
    tempoViagemMin = diff;
  }

  let baseEspera = 0;
  if(ini!=null && chegada!=null){
    let diff = ini - chegada;
    if(diff<0) diff += 24*60;
    baseEspera = diff;
  }

  let atrasoMin = 0;
  if(Array.isArray(d.funcionarios)){
    atrasoMin = d.funcionarios.reduce((acc,f)=>{
      if(f.atraso==='sim' && f.minutosAtraso>0) return acc + f.minutosAtraso;
      return acc;
    },0);
  }

  const tempoEsperaMin = baseEspera + atrasoMin;

  let totalKm = null;
  const ki = parseFloat(d.kmInicial);
  const kf = parseFloat(d.kmFinal);
  if(!isNaN(ki) && !isNaN(kf)){
    const diff = kf - ki;
    totalKm = diff >= 0 ? +diff.toFixed(1) : 0;
  }

  return {
    tempoViagemMin,
    tempoEsperaMin,
    tempoViagemStr: formatMin(tempoViagemMin),
    tempoEsperaStr: formatMin(tempoEsperaMin),
    totalKm
  };
}

/* ATUALIZAR UI DOS TOTAIS */
function recomputeDerivedUI(){
  const dados = readDadosFromDOM();
  const d = computeDerivedFromData(dados);
  $('totalKmDisplay').innerText = d.totalKm!=null ? d.totalKm+' km' : '-';
  $('tempoEsperaDisplay').innerText = d.tempoEsperaStr;
  $('tempoViagemDisplay').innerText = d.tempoViagemStr;
}

/* HIST√ìRICO */
function renderHistorico(){
  const lista = $('listaRecibos');
  const recs = loadRecibos();
  if(!recs.length){
    lista.innerHTML = '<div class="small">Nenhum recibo emitido at√© agora.</div>';
    return;
  }
  let html='';
  recs.forEach(r=>{
    const dataLabel = formatDateBr(r.dataViagem || r.createdAt);
    const empresaLabel = r.empresaDestino || '-';
    const kmLabel = (r.resumoKm!=null ? r.resumoKm+' km' : '');
    html += `
      <div class="hist-item">
        <div>
          <div style="font-weight:700;">${dataLabel} ‚Äî ${empresaLabel}</div>
          <div class="small">${kmLabel}</div>
        </div>
        <div class="actions">
          <button class="btn-sm" data-id="${r.id}" data-action="pdf">PDF</button>
          <button class="btn-sm" data-id="${r.id}" data-action="del" style="background:#e11d48;color:#fff;border:none;">Excluir</button>
        </div>
      </div>
    `;
  });
  lista.innerHTML = html;
  lista.querySelectorAll('button[data-action]').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const id = Number(btn.getAttribute('data-id'));
      const action = btn.getAttribute('data-action');
      if(action==='pdf') baixarRecibo(id);
      if(action==='del') excluirRecibo(id);
    });
  });
}
function excluirRecibo(id){
  if(!confirm('Excluir este recibo do hist√≥rico?')) return;
  let recs=loadRecibos();
  recs = recs.filter(r=>r.id!==id);
  saveRecibos(recs);
  renderHistorico();
}
function baixarRecibo(id){
  const recs=loadRecibos();
  const rec=recs.find(r=>r.id===id);
  if(!rec) return;
  const perfil=getPerfil();
  const derived=computeDerivedFromData(rec.dados);
  gerarPdf(rec.dados, perfil, derived);
}

/* GERAR PDF ESTRUTURADO */
function gerarPdf(dados, perfil, derived){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p','mm','a4');
  const pageWidth = doc.internal.pageSize.getWidth();
  const marginX = 15;

  let y = 15;

  // T√çTULO
  doc.setFont('helvetica','bold');
  doc.setFontSize(18);
  doc.text('RECIBO DE VIAGEM', pageWidth/2, y, {align:'center'});
  y += 8;

  if(perfil.empresa){
    doc.setFontSize(11);
    doc.setFont('helvetica','normal');
    doc.text(perfil.empresa, pageWidth/2, y, {align:'center'});
    y += 5;
  }
  if(perfil.cnpj){
    doc.setFontSize(10);
    doc.text('CNPJ: '+perfil.cnpj, pageWidth/2, y, {align:'center'});
    y += 6;
  } else {
    y += 4;
  }

  function drawSection(title, lines){
    const boxWidth = pageWidth - marginX*2;
    const lineHeight = 5;
    const innerHeight = 8 + lines.length*lineHeight + 4;
    const boxY = y;
    doc.setDrawColor(150);
    doc.roundedRect(marginX, boxY, boxWidth, innerHeight, 2, 2);
    doc.setFont('helvetica','bold');
    doc.setFontSize(12);
    doc.text(title, marginX+3, boxY+6);
    doc.setFont('helvetica','normal');
    doc.setFontSize(10);
    let ty = boxY+12;
    lines.forEach(line=>{
      if(line){ doc.text(line, marginX+4, ty); }
      ty += lineHeight;
    });
    y = boxY + innerHeight + 4;
  }

  // SE√á√ÉO 1 - EMPRESA / MOTORISTA
  drawSection('Dados da Empresa / Motorista', [
    'Empresa: ' + (perfil.empresa||'-'),
    'CNPJ: ' + (perfil.cnpj||'-'),
    'Motorista: ' + (perfil.motorista||'-'),
    'CPF/RG: ' + (perfil.cpf||'-'),
    'Ve√≠culo: ' + ((perfil.marca||'') + ' ' + (perfil.modelo||'') + ' - ' + (perfil.cor||'')),
    'Placa: ' + (perfil.placa||'-')
  ]);

  // SE√á√ÉO 2 - VIAGEM & EMPRESAS
  drawSection('Dados da Viagem & Empresa', [
    'Empresa de destino: ' + (dados.empresaDestino||'-'),
    'Empresa respons√°vel pelos funcion√°rios: ' + (dados.empresaResponsavel||'-'),
    'Solicitante da viagem: ' + (dados.solicitante||'-'),
    'Data da viagem: ' + formatDateBr(dados.dataViagem),
    'Hor√°rio de chegada no ponto: ' + (dados.horaChegada||'-'),
    'Descri√ß√£o / tipo de servi√ßo: ' + (dados.descricao||'-')
  ]);

  // SE√á√ÉO 3 - FUNCION√ÅRIOS
  const funcLines = [];
  (dados.funcionarios||[]).forEach((f,i)=>{
    if(!f.nome && !f.empresa && !f.local && !f.horaEmbarque) return;
    funcLines.push(`Funcion√°rio ${i+1}: ${f.nome||'-'}`);
    funcLines.push('Empresa: ' + (f.empresa||'-') + '  |  Local: ' + (f.local||'-'));
    const atrasoTxt = f.atraso==='sim'
      ? 'Sim' + (f.minutosAtraso>0 ? ' ('+f.minutosAtraso+' min)' : '')
      : 'N√£o';
    funcLines.push('Hor√°rio de embarque: ' + (f.horaEmbarque||'-') + '  |  Atraso: ' + atrasoTxt);
    funcLines.push('');
  });
  if(!funcLines.length){
    funcLines.push('Nenhum funcion√°rio informado.');
  }
  drawSection('Funcion√°rios', funcLines);

  // SE√á√ÉO 4 - HOR√ÅRIOS & KM
  drawSection('Hor√°rios & Quilometragem', [
    'Hor√°rio inicial: ' + (dados.horaInicio||'-'),
    'KM inicial: ' + (dados.kmInicial||'-'),
    'Hor√°rio final: ' + (dados.horaFim||'-'),
    'KM final: ' + (dados.kmFinal||'-'),
    'Total de KM: ' + (derived.totalKm!=null ? derived.totalKm+' km' : '-'),
    'Tempo de espera total: ' + derived.tempoEsperaStr,
    'Tempo de viagem: ' + derived.tempoViagemStr
  ]);

  // SE√á√ÉO 5 - RESUMO FINANCEIRO
  drawSection('Resumo Financeiro', [
    'Valor total da viagem: R$ ' + (dados.valor || '-'),
    'Data da viagem: ' + formatDateBr(dados.dataViagem)
  ]);

  // SE√á√ÉO 6 - ASSINATURAS
  y += 6;
  doc.setFontSize(10);
  doc.text('____________________________________', marginX, y);
  y += 5;
  doc.text('Motorista: ' + (perfil.motorista||''), marginX, y);
  y += 10;
  doc.text('____________________________________', marginX, y);
  y += 5;
  doc.text('Respons√°vel: ' + (dados.solicitante||''), marginX, y);

  doc.save('recibo_viagem.pdf');
}

/* EMITIR PDF (BOT√ÉO) */
$('emitirPdf').addEventListener('click', ()=>{
  const perfil=getPerfil();
  if(!perfil.motorista || !perfil.cpf || !perfil.marca || !perfil.modelo || !perfil.placa || !perfil.cor){
    alert('Preencha e salve o cadastro do recibo (motorista e ve√≠culo) antes de emitir.');
    return;
  }
  const dados = readDadosFromDOM();

  if(!dados.empresaDestino){
    alert('Informe a empresa de destino.');
    return;
  }
  if(!dados.solicitante){
    alert('Informe o solicitante da viagem.');
    return;
  }

  const temFunc = (dados.funcionarios||[]).some(f=>f.nome);
  if(!temFunc){
    alert('Informe pelo menos um funcion√°rio.');
    return;
  }

  const derived = computeDerivedFromData(dados);
  gerarPdf(dados, perfil, derived);

  // salva hist√≥rico
  let recs = loadRecibos();
  recs.unshift({
    id: Date.now(),
    createdAt: new Date().toISOString(),
    empresaDestino: dados.empresaDestino,
    dataViagem: dados.dataViagem,
    resumoKm: derived.totalKm,
    dados
  });
  saveRecibos(recs);
  renderHistorico();
});

/* WHATSAPP */
$('enviarWa').addEventListener('click', ()=>{
  const perfil=getPerfil();
  const dados=readDadosFromDOM();
  const derived=computeDerivedFromData(dados);

  const funcsTxt = (dados.funcionarios||[])
    .filter(f=>f.nome)
    .map((f,i)=>{
      const atrasoTxt = f.atraso==='sim'
        ? 'Sim' + (f.minutosAtraso>0 ? ' ('+f.minutosAtraso+' min)' : '')
        : 'N√£o';
      return `Funcion√°rio ${i+1}: ${f.nome}
Empresa: ${f.empresa||'-'}
Local de embarque: ${f.local||'-'}
Hor√°rio de embarque: ${f.horaEmbarque||'-'}
Atraso: ${atrasoTxt}`;
    }).join('\n\n') || 'Nenhum informado';

  const msg = 
`RECIBO DE VIAGEM

Empresa: ${perfil.empresa||'-'}
CNPJ: ${perfil.cnpj||'-'}
Motorista: ${perfil.motorista||'-'}
CPF/RG: ${perfil.cpf||'-'}
Ve√≠culo: ${perfil.marca||''} ${perfil.modelo||''} - ${perfil.cor||''}
Placa: ${perfil.placa||''}

Destino: ${dados.empresaDestino||'-'}
Respons√°vel pelos funcion√°rios: ${dados.empresaResponsavel||'-'}
Solicitante da viagem: ${dados.solicitante||'-'}
Data da viagem: ${formatDateBr(dados.dataViagem)}
Chegada no ponto: ${dados.horaChegada||'-'}
Descri√ß√£o / servi√ßo: ${dados.descricao||'-'}

--- Funcion√°rios ---
${funcsTxt}

Hor√°rio inicial: ${dados.horaInicio||'-'}
KM inicial: ${dados.kmInicial||'-'}
Hor√°rio final: ${dados.horaFim||'-'}
KM final: ${dados.kmFinal||'-'}
Total de KM: ${derived.totalKm!=null ? derived.totalKm+' km' : '-'}

Tempo de espera total: ${derived.tempoEsperaStr}
Tempo de viagem: ${derived.tempoViagemStr}

Motorista: ${perfil.motorista||'-'}
Respons√°vel: ${dados.solicitante||'-'}`;

  window.open('https://wa.me/?text='+encodeURIComponent(msg));
});

/* EVENTOS DE INPUT PARA RECALCULAR TOTAIS */
['horaChegada','horaInicio','horaFim','kmInicial','kmFinal'].forEach(id=>{
  const el=$(id); if(el) el.addEventListener('input',recomputeDerivedUI);
});

/* BOT√ïES FUNCION√ÅRIOS & BOOT */
$('addFuncionarioBtn').addEventListener('click', adicionarFuncionario);
$('removerFuncionarioBtn').addEventListener('click', removerFuncionario);

document.addEventListener('DOMContentLoaded', ()=>{
  // pelo menos 1 funcion√°rio
  if(!document.querySelector('.funcionario-block')){
    adicionarFuncionario();
  }
  recomputeDerivedUI();
  renderHistorico();
});
</script>

</body>
</html>

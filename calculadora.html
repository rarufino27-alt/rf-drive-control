<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Calculadora Integrada - RF Driver</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

<style>
:root{
    --bg:#ffffff;
    --page-gap:#f3f5f8;
    --card:#fafbfc;
    --card-strong:#f0f2f5;
    --panel:#ffffff;
    --text:#0b1115;
    --muted:#65707a;
    --brand:#0b5bd7;
    --brand-dark:#073f8a;
    --accent-danger:#ff3b30;
    --shadow:0 6px 16px rgba(13,30,45,0.07);
    --radius:14px;
}

.dark{
    --bg:#0f1115;
    --page-gap:#15171c;
    --card:#181a20;
    --card-strong:#1d1f27;
    --panel:#1b1d25;
    --text:#e5e7eb;
    --muted:#9ca3af;
    --brand:#3b82f6;
    --brand-dark:#2563eb;
}

*{ box-sizing:border-box; font-family:Inter,system-ui; }

body{
    margin:0;
    background:linear-gradient(180deg, var(--page-gap), var(--bg) 50%);
    color:var(--text);
    padding-bottom:120px;
    padding-top:70px; /* espa√ßo menu */
}

/* MENU */
.top-menu{
    position:fixed;
    top:0;
    left:0;
    width:100%;
    background:var(--panel);
    display:flex;
    padding:8px;
    gap:8px;
    align-items:center;
    z-index:9999;
    overflow-x:auto;
    box-shadow:var(--shadow);
}
.top-menu button{
    padding:10px 14px;
    background:var(--card);
    border:1px solid rgba(0,0,0,0.08);
    border-radius:10px;
    font-weight:700;
    cursor:pointer;
    flex-shrink:0;
    color:var(--text);
}

/* header */
header{
    padding:18px 16px;
    max-width:980px;
    margin:0 auto;
    display:flex;
    align-items:center;
    justify-content:space-between;
}
#toggleTheme{
    background:var(--card-strong);
    padding:8px 12px;
    border-radius:10px;
    cursor:pointer;
    color:var(--text);
    font-weight:700;
}

/* container */
.container{
    max-width:980px;
    margin:20px auto;
    padding:0 16px;
}

/* cards */
.card{
    background:var(--card);
    padding:16px;
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    margin-bottom:16px;
}

/* abas */
.tab-bar{
    display:flex;
    background:var(--card-strong);
    border-radius:12px;
    overflow:hidden;
    margin-bottom:16px;
}
.tab-button{
    flex:1;text-align:center;padding:12px 0;
    cursor:pointer;font-weight:700;color:var(--muted);
}
.tab-button.active{
    background:linear-gradient(135deg,var(--brand),var(--brand-dark));
    color:#fff;
}

/* forms */
label{
    display:block;margin-top:10px;font-size:13px;color:var(--muted);font-weight:700;
}
input,select{
    width:100%;padding:10px;border-radius:10px;
    background:var(--card-strong);
    border:none;margin-top:6px;color:var(--text);
}
button{
    padding:12px;border:0;border-radius:10px;
    background:linear-gradient(135deg,var(--brand),var(--brand-dark));
    color:#fff;font-weight:700;cursor:pointer;
    margin-top:12px;
}
.resultado{
    background:var(--card-strong);
    padding:10px;border-radius:10px;margin-top:8px;font-weight:700;
}
</style>

</head>

<body>

<!-- MENU SUPERIOR -->
<div class="top-menu">
  <button onclick="location.href='planos.html'">üíé Planos</button>
  <button onclick="location.href='perfil.html'">üë§ Perfil</button>
  <button onclick="location.href='index.html'">üè† Dashboard</button>
  <button onclick="location.href='entradas.html'">üíµ Entradas</button>
  <button onclick="location.href='resumo.html'">üßÆ Resumo</button>
  <button onclick="location.href='recibo_empresa.html'">üè≠ Empresa</button>
  <button onclick="location.href='recibo_particular.html'">üöò Particular</button>
  <button onclick="location.href='manutencao.html'">üõ† Manuten√ß√£o</button>
  <button onclick="location.href='calculadora.html'">üìü Calculadora</button>
</div>

<header>
    <div class="brand" style="display:flex;align-items:center;gap:10px;">
        <div class="logo">RF Driver</div>
        <h1 style="margin:0;font-size:28px;font-weight:800">Calculadora</h1>
    </div>
    <button id="toggleTheme">üåô</button>
</header>

<main class="container">

    <!-- ABAS -->
    <div class="tab-bar">
        <div id="tabSimples" class="tab-button active">Simples</div>
        <div id="tabPremium" class="tab-button">Premium ‚≠ê</div>
    </div>

    <!-- -------------------- ABA SIMPLES -------------------- -->
    <section id="abaSimples" class="card" style="display:block">
        <h2>Calculadora Simples</h2>

        <label>Motorista</label><input id="motorista">
        <label>CPF/CNPJ</label><input id="cpfCnpj">
        <label>Carro / Modelo</label><input id="carro">
        <label>Placa</label><input id="placa">
        <label>Origem</label><input id="origem">
        <label>Destino</label><input id="destino">

        <label>Valor por KM</label><input id="valorKm" type="number" step="0.01">
        <label>KM Rodado</label><input id="kmRodado" type="number" step="0.01">
        <label>Dura√ß√£o (minutos)</label><input id="duracaoMin" type="number">

        <label>Tipo de uso</label>
        <select id="tipoUso">
            <option value="cidade">Cidade</option>
            <option value="pista">Pista</option>
        </select>

        <label>Tipo de viagem</label>
        <select id="tipoViagem">
            <option value="soIdaComVolta">S√≥ ida (com volta)</option>
            <option value="soIdaSemVolta">S√≥ ida (sem volta)</option>
            <option value="idaVoltaEspera">Ida e volta + espera</option>
            <option value="idaVolta">Ida e volta</option>
            <option value="bateVolta">Bate e volta</option>
        </select>

        <button id="btnCalcularSimples">Calcular Estimativa</button>
        <button id="btnEnviarWhatsSimples" style="background:#128c7e">Enviar WhatsApp</button>

        <div id="resultadoSimples" class="resultado"></div>
    </section>

    <!-- -------------------- ABA PREMIUM -------------------- -->
    <section id="abaPremium" class="card" style="display:none">
        <h2>Calculadora Premium ‚≠ê</h2>
        <p class="small">C√°lculos avan√ßados: combust√≠veis, plataformas, lucro, gr√°fico e hist√≥rico.</p>

        <!-- Combust√≠veis -->
        <div class="card">
            <h3>Gasolina / Etanol</h3>
            <label>Pre√ßo Gasolina (R$/L)</label><input id="gasolinaPreco" type="number" step="0.01">
            <label>Consumo Gasolina (km/L)</label><input id="gasolinaConsumo" type="number" step="0.1">
            <label>Pre√ßo Etanol (R$/L)</label><input id="etanolPreco" type="number" step="0.01">
            <label>Consumo Etanol (km/L)</label><input id="etanolConsumo" type="number" step="0.1">
            <button id="btnSalvarComb">Salvar Combust√≠veis</button>
        </div>

        <!-- GNV -->
        <div class="card">
            <h3>GNV</h3>
            <label>Pre√ßo do Cilindro Cheio (R$)</label><input id="gnvPrecoCilindro" type="number">

            <label>Autonomia Total (km)</label><input id="gnvAutonomiaKm" type="number">

            <label>Capacidade (m¬≥)</label><input id="gnvCapacidade" type="number">

            <hr>

            <label>Pre√ßo por m¬≥ (auto)</label><input id="gnvPrecoPorM3" readonly>

            <label>Autonomia por m¬≥ (km/m¬≥)</label><input id="gnvAutonomiaPorM3" readonly>

            <button id="btnSalvarGnv">Salvar GNV</button>
        </div>

        <!-- Dados da corrida -->
        <div class="card">
            <h3>Dados da Corrida</h3>

            <label>Km at√© passageiro</label><input id="kmIda" type="number" value="1">

            <label>Km da corrida</label><input id="kmViagem" type="number" value="8">

            <label>Valor recebido (R$)</label><input id="valorRecebido" type="number" value="18.50">

            <label>Taxas das plataformas (%)</label>
            <div style="display:flex;gap:8px">
                <input id="taxUber" type="number" value="25" placeholder="Uber">
                <input id="tax99" type="number" value="24" placeholder="99">
                <input id="taxIndriver" type="number" value="10" placeholder="InDriver">
            </div>

            <label>Combust√≠vel</label>
            <select id="tipoCombustivel">
                <option value="gasolina">Gasolina</option>
                <option value="etanol">Etanol</option>
                <option value="gnv">GNV</option>
                <option value="auto">Autom√°tico (mais barato)</option>
            </select>

            <button id="btnCalcPremium">Calcular Premium</button>
            <button id="btnExportPdf" style="background:#0b5bd7">Exportar PDF</button>

            <button id="btnWhatsPremium" style="background:#128c7e">Enviar WhatsApp</button>
            <button id="btnLimparHist" style="background:#ff6b6b">Limpar Hist√≥rico</button>
        </div>

        <div class="card"><h3>Resultados</h3>
            <label>Custo por KM</label><div id="r_cck" class="resultado"></div>
            <label>Lucro L√≠quido</label><div id="r_lucro" class="resultado"></div>
            <label>Comb. mais barato</label><div id="r_combustivelMaisBarato" class="resultado"></div>
            <label>Melhor plataforma</label><div id="r_melhorPlataforma" class="resultado"></div>
            <label>Recomenda√ß√£o</label><div id="r_indicacao" class="resultado"></div>
            <div id="r_comp" style="margin-top:10px"></div>
        </div>

        <div id="graficoPremium" class="card"></div>
        <div id="historicoPremium" class="card"></div>

    </section>

</main>

<div style="height:120px"></div>

<!-- ====== Bot√£o menu ====== -->
<div class="menu-button" onclick="openMenu()">
  <span class="icon">‚ò∞</span>
  <span>Menu</span>
</div>

<!-- ====== Sidebar ====== -->
<div id="sidebar" class="sidebar">
  <span class="menu-close" onclick="closeMenu()">√ó</span>
  <div class="menu-title">Navega√ß√£o</div>
  <div class="menu-item" onclick="location.href='planos.html'">üíé Planos</div>
  <div class="menu-item" onclick="location.href='index.html'">üè† Dashboard</div>
  <div class="menu-item" onclick="location.href='entradas.html'">üíµ Entradas</div>
  <div class="menu-item" onclick="location.href='recibo_empresa.html'">üè≠ Empresa</div>
  <div class="menu-item" onclick="location.href='recibo_particular.html'">üöò Particular</div>
  <div class="menu-item" onclick="location.href='manutencao.html'">üõ† Manuten√ß√£o</div>
  <div class="menu-item" onclick="location.href='resumo.html'">üßÆ Resumo</div>
  <div class="menu-item" onclick="location.href='perfil.html'">üë§ Perfil</div>
  <div class="menu-item" onclick="location.href='calculadora.html'">üìü Calculadora</div>
</div>

<script src="planos.js"></script>

<script>
if(!planoTem("calcSimples")){
  alert("Funcionalidade bloqueada.");
  location.href="planos.html";
}
</script>

<!-- ---------------------------- JS CORRIGIDO ---------------------------- -->
<script>

/* === VARI√ÅVEIS === */
const PERFIL_KEY = 'perfilCalc_v2', COMB_KEY='combPremium_v2', GNV_KEY='gnvPremium_v2', HIST_KEY='premiumHist_v2';

/* === TEMA === */
const toggleTheme = document.getElementById('toggleTheme');
function applyTheme(){
  const t = localStorage.getItem('theme') || 'light';
  if(t === 'dark'){ document.body.classList.add('dark'); toggleTheme.textContent = '‚òÄÔ∏è'; }
  else { document.body.classList.remove('dark'); toggleTheme.textContent = 'üåô'; }
}
toggleTheme.onclick = ()=>{ 
    localStorage.setItem('theme', document.body.classList.contains('dark') ? 'light' : 'dark'); 
    applyTheme(); 
};
applyTheme();

/* === ABAS === */
const tabSimples = document.getElementById('tabSimples'),
      tabPremium = document.getElementById('tabPremium'),
      abaSimples = document.getElementById('abaSimples'),
      abaPremium = document.getElementById('abaPremium');

tabSimples.onclick = ()=>{ 
    tabSimples.classList.add('active'); 
    tabPremium.classList.remove('active'); 
    abaSimples.style.display='block'; 
    abaPremium.style.display='none'; 
};

tabPremium.onclick = ()=>{ 
    tabPremium.classList.add('active'); 
    tabSimples.classList.remove('active'); 
    abaPremium.style.display='block'; 
    abaSimples.style.display='none'; 
};

/* === UTILIT√ÅRIOS === */
function fmt(v){ if(v===Infinity||isNaN(v)) return 'N/D'; return 'R$ '+Number(v).toFixed(2); }
function formatReal(v){ return 'R$ '+Number(v).toFixed(2); }

/* === PERFIL LOCAL === */
function salvarPerfilLocal(){
  const p={
    motorista:document.getElementById('motorista').value,
    cpfCnpj:document.getElementById('cpfCnpj').value,
    carro:document.getElementById('carro').value,
    placa:document.getElementById('placa').value
  };
  localStorage.setItem(PERFIL_KEY, JSON.stringify(p));
}
function carregarPerfilLocal(){
  const p = JSON.parse(localStorage.getItem(PERFIL_KEY) || '{}');
  if(p.motorista) motorista.value = p.motorista;
  if(p.cpfCnpj) cpfCnpj.value = p.cpfCnpj;
  if(p.carro) carro.value = p.carro;
  if(p.placa) placa.value = p.placa;
}
['motorista','cpfCnpj','carro','placa'].forEach(id=>{
  document.getElementById(id).addEventListener('input', salvarPerfilLocal);
});
carregarPerfilLocal();

/* === GNV AUTOM√ÅTICO === */
function atualizarGnvAutomatico(){
  const preco = Number(gnvPrecoCilindro.value)||0;
  const autonomiaKm = Number(gnvAutonomiaKm.value)||0;
  const capacidade = Number(gnvCapacidade.value)||0;

  if(capacidade>0){
    gnvPrecoPorM3.value = (preco/capacidade).toFixed(2);
    gnvAutonomiaPorM3.value = (autonomiaKm/capacidade).toFixed(2);
  } else {
    gnvPrecoPorM3.value = '';
    gnvAutonomiaPorM3.value = '';
  }
}

['gnvPrecoCilindro','gnvAutonomiaKm','gnvCapacidade'].forEach(id=>{
  document.getElementById(id).addEventListener('input', atualizarGnvAutomatico);
});

/* === SALVAR COMBUST√çVEIS === */
document.getElementById('btnSalvarComb').onclick = ()=>{
  const c={
    gasolinaPreco:Number(gasolinaPreco.value)||0,
    gasolinaConsumo:Number(gasolinaConsumo.value)||0,
    etanolPreco:Number(etanolPreco.value)||0,
    etanolConsumo:Number(etanolConsumo.value)||0
  };
  localStorage.setItem(COMB_KEY, JSON.stringify(c));
  alert('Combust√≠veis salvos!');
};

/* === SALVAR GNV === */
document.getElementById('btnSalvarGnv').onclick = ()=>{
  const g={
    precoCilindro:Number(gnvPrecoCilindro.value)||0,
    autonomiaKm:Number(gnvAutonomiaKm.value)||0,
    capacidade:Number(gnvCapacidade.value)||0,
    precoPorM3:Number(gnvPrecoPorM3.value)||0,
    autonomiaPorM3:Number(gnvAutonomiaPorM3.value)||0
  };
  localStorage.setItem(GNV_KEY, JSON.stringify(g));
  alert('GNV salvo!');
};

/* === CARREGAR CONFIG SALVA === */
function renderCombValues(){
  const c = JSON.parse(localStorage.getItem(COMB_KEY) || '{}');
  gasolinaPreco.value = c.gasolinaPreco || '';
  gasolinaConsumo.value = c.gasolinaConsumo || '';
  etanolPreco.value = c.etanolPreco || '';
  etanolConsumo.value = c.etanolConsumo || '';

  const g = JSON.parse(localStorage.getItem(GNV_KEY) || '{}');
  gnvPrecoCilindro.value = g.precoCilindro || '';
  gnvAutonomiaKm.value = g.autonomiaKm || '';
  gnvCapacidade.value = g.capacidade || '';
  gnvPrecoPorM3.value = g.precoPorM3 || '';
  gnvAutonomiaPorM3.value = g.autonomiaPorM3 || '';

  atualizarGnvAutomatico();
}
renderCombValues();

/* === CALCULAR SIMPLES === */
btnCalcularSimples.onclick = ()=>{
  const km = Number(kmRodado.value)||0;
  const valKm = Number(valorKm.value)||0;
  const dur = Number(duracaoMin.value)||0;

  if(!km||!valKm){ alert("Preencha todos os campos!"); return; }

  const comb = JSON.parse(localStorage.getItem(COMB_KEY) || '{}');
  const g = JSON.parse(localStorage.getItem(GNV_KEY) || '{}');

  const custos=[];
  if(comb.gasolinaPreco && comb.gasolinaConsumo) custos.push({name:'Gasolina', cost: comb.gasolinaPreco/comb.gasolinaConsumo});
  if(comb.etanolPreco && comb.etanolConsumo) custos.push({name:'Etanol', cost: comb.etanolPreco/comb.etanolConsumo});
  if(g.precoCilindro && g.autonomiaKm) custos.push({name:'GNV', cost: g.precoCilindro/g.autonomiaKm});

  let menor = custos.length ? custos.reduce((a,b)=>a.cost<b.cost?a:b) : null;

  const bruto = km*valKm;
  const custo = menor ? km*menor.cost : 0;
  const liquido = bruto - custo;

  resultadoSimples.innerText =
      `Valor Bruto: ${fmt(bruto)}\nCusto Estimado: ${menor?fmt(custo)+' ('+menor.name+')':'N/D'}\nLucro Estimado: ${fmt(liquido)}\nDura√ß√£o: ${dur} min`;
};

/* === PREMIUM CALCULOS === */
function calcularCustosCombustiveis(){
  const c = JSON.parse(localStorage.getItem(COMB_KEY)||'{}');
  const g = JSON.parse(localStorage.getItem(GNV_KEY)||'{}');

  return {
    gasCost: c.gasolinaPreco&&c.gasolinaConsumo ? c.gasolinaPreco/c.gasolinaConsumo : Infinity,
    etaCost: c.etanolPreco&&c.etanolConsumo ? c.etanolPreco/c.etanolConsumo : Infinity,
    gnvCost: g.precoCilindro&&g.autonomiaKm ? g.precoCilindro/g.autonomiaKm : Infinity
  };
}

function calcularPlataformas(valor,custo){
  return {
    uber: valor - custo - (valor*(taxUber.value/100)),
    novenove: valor - custo - (valor*(tax99.value/100)),
    indriver: valor - custo - (valor*(taxIndriver.value/100))
  };
}

btnCalcPremium.onclick = ()=>{

  const kmTotal = Number(kmIda.value)+Number(kmViagem.value);
  const valor = Number(valorRecebido.value);
  const tipo = tipoCombustivel.value;

  const {gasCost,etaCost,gnvCost} = calcularCustosCombustiveis();
  let custoEscolhido=Infinity, nome='N/D';

  if(tipo==='gasolina'){ custoEscolhido=gasCost; nome='Gasolina'; }
  else if(tipo==='etanol'){ custoEscolhido=etaCost; nome='Etanol'; }
  else if(tipo==='gnv'){ custoEscolhido=gnvCost; nome='GNV'; }
  else {
    const menor = Math.min(gasCost,etaCost,gnvCost);
    custoEscolhido = menor;
    nome = (menor===gasCost?'Gasolina':menor===etaCost?'Etanol':'GNV');
  }

  const custoTotal = kmTotal*custoEscolhido;
  const {uber,novenove,indriver} = calcularPlataformas(valor,custoTotal);

  const melhor = Math.max(uber,novenove,indriver);
  const melhorPlataforma = melhor===uber?'Uber':melhor===novenove?'99':'InDriver';

  r_cck.innerText = fmt(custoEscolhido);
  r_combustivelMaisBarato.innerText = nome;
  r_melhorPlataforma.innerText = `${melhorPlataforma} (${fmt(melhor)})`;

  r_lucro.innerHTML = fmt(melhor);

  r_indicacao.innerText = melhor>0?'ACEITE':'N√ÉO VALE A PENA';

  r_comp.innerHTML =
      `<div style="padding:10px;background:var(--panel);border-radius:10px">
        <b>Comparativo combust√≠veis</b><br>
        Gasolina: ${fmt(gasCost)} ‚Äî Etanol: ${fmt(etaCost)} ‚Äî GNV: ${fmt(gnvCost)}
       </div>`;

  salvarHistorico({t:Date.now(), km:kmTotal, lucro:melhor, comb:nome, platform:melhorPlataforma});
  renderHistorico(); 
  renderGrafico();
};

/* === HIST√ìRICO === */
function salvarHistorico(item){
  const arr = JSON.parse(localStorage.getItem(HIST_KEY)||'[]');
  arr.push(item);
  if(arr.length>300) arr.shift();
  localStorage.setItem(HIST_KEY, JSON.stringify(arr));
}

function renderHistorico(){
  const arr = JSON.parse(localStorage.getItem(HIST_KEY)||'[]');
  if(!arr.length){
    historicoPremium.innerHTML="<h3>Hist√≥rico</h3><p class='small'>Nenhum dado.</p>";
    return;
  }

  let html = "<h3>Hist√≥rico Premium</h3><table class='table'><tr><th>Data</th><th>KMs</th><th>Lucro</th><th>Comb</th><th>Plat</th></tr>";

  arr.slice().reverse().forEach(r=>{
    html+=`<tr>
      <td>${new Date(r.t).toLocaleString()}</td>
      <td>${r.km}</td>
      <td>${fmt(r.lucro)}</td>
      <td>${r.comb}</td>
      <td>${r.platform}</td>
    </tr>`;
  });

  html+="</table>";
  historicoPremium.innerHTML = html;
}
renderHistorico();

/* === GR√ÅFICO === */
function renderGrafico(){
  const arr = JSON.parse(localStorage.getItem(HIST_KEY)||'[]');
  if(!arr.length){
    graficoPremium.innerHTML="<h3>Gr√°fico</h3><p class='small'>Nenhum dado.</p>";
    return;
  }

  let html="<h3>Lucro (√öltimos)</h3>";
  arr.slice(-12).forEach(r=>{
    const w = Math.min(300, Math.abs(r.lucro)*3);
    const cor = r.lucro>=0?'#0a7d26':'#c50000';
    html += `<div style="margin-bottom:6px">
      <div style="display:inline-block;height:12px;background:${cor};width:${w}px;border-radius:6px"></div>
      <small> ${fmt(r.lucro)}</small>
    </div>`;
  });

  graficoPremium.innerHTML = html;
}
renderGrafico();

/* === EXPORTAR PDF SIMPLES === */
btnExportPdf.onclick = ()=>{
  const html = `
  <html><body>
  <h2>Relat√≥rio Premium - RF Driver</h2>
  <p>${r_cck.innerText}</p>
  <p>${r_lucro.innerText}</p>
  <p>${r_melhorPlataforma.innerText}</p>
  </body></html>
  `;
  const w = window.open();
  w.document.write(html); w.print();
};

/* === WHATS PREMIUM === */
btnWhatsPremium.onclick = ()=>{
  const msg = `üìü Relat√≥rio Premium\nCusto/KM: ${r_cck.innerText}\nLucro: ${r_lucro.innerText}\nPlataforma: ${r_melhorPlataforma.innerText}`;
  window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`);
};

btnLimparHist.onclick = ()=>{
  if(confirm("Limpar hist√≥rico?")){
    localStorage.removeItem(HIST_KEY);
    renderHistorico();
    renderGrafico();
  }
};

function openMenu(){
  document.getElementById('sidebar').classList.add('open');
}
function closeMenu(){
  document.getElementById('sidebar').classList.remove('open');
}

</script>
</body>
</html>
